<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Janus Food Group - Quality Management System</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --janus-green: #0d3b2d;
      --janus-green-light: #145c46;
      --janus-green-dark: #092a20;
      --accent: #10b981;
      --bg-primary: #f8faf9;
      --bg-secondary: #ffffff;
      --text-primary: #1a2e28;
      --text-secondary: #4a6358;
      --text-muted: #7a9488;
      --border-light: #d1ddd7;
      --error: #dc2626;
      --error-light: #fef2f2;
      --warning: #f59e0b;
      --warning-light: #fffbeb;
      --success: #10b981;
      --success-light: #ecfdf5;
      --info: #3b82f6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--janus-green); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--janus-green-light); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover:not(:disabled) { background: #059669; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-light); }
    .btn-secondary:hover:not(:disabled) { background: var(--bg-primary); }
    .btn-ghost { background: transparent; color: var(--janus-green); }
    .btn-ghost:hover { background: rgba(13, 59, 45, 0.1); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    
    .card { background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card-clickable { cursor: pointer; transition: all 0.2s; }
    .card-clickable:hover { border-color: var(--janus-green); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(13,59,45,0.1); }
    
    .input { width: 100%; padding: 10px 14px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit; font-size: 14px; transition: all 0.2s; }
    .input:focus { outline: none; border-color: var(--janus-green); box-shadow: 0 0 0 3px rgba(13, 59, 45, 0.1); }
    .input:disabled { background: var(--bg-primary); color: var(--text-muted); }
    .input.error { border-color: var(--error); background: var(--error-light); }
    .input.success { border-color: var(--success); background: var(--success-light); }
    select.input { cursor: pointer; }
    textarea.input { resize: vertical; min-height: 80px; }
    
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; display: inline-block; }
    .badge-success { background: var(--success-light); color: #047857; }
    .badge-warning { background: var(--warning-light); color: #b45309; }
    .badge-error { background: var(--error-light); color: #b91c1c; }
    .badge-info { background: #eff6ff; color: #1d4ed8; }
    .badge-neutral { background: var(--bg-primary); color: var(--text-secondary); }
    
    .notification { position: fixed; top: 80px; right: 20px; padding: 14px 20px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; animation: slideIn 0.3s ease; max-width: 400px; }
    .notification.success { background: var(--success); }
    .notification.error { background: var(--error); }
    .notification.info { background: var(--info); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-light); }
    th { background: var(--bg-primary); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
    tbody tr { cursor: pointer; }
    tbody tr:hover { background: rgba(13, 59, 45, 0.02); }
    
    .tabs { display: flex; gap: 8px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-bottom: 3px solid var(--janus-green); padding: 16px 20px 0; overflow-x: auto; }
    .tab { padding: 14px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-bottom: none; color: var(--text-muted); cursor: pointer; font-weight: 600; font-size: 15px; border-radius: 10px 10px 0 0; margin-bottom: -3px; white-space: nowrap; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
    .tab.active { color: white; background: var(--janus-green); border-color: var(--janus-green); box-shadow: 0 -4px 12px rgba(13, 59, 45, 0.4); }
    .tab:hover:not(.active) { color: var(--text-primary); background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); transform: translateY(-2px); }
    
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; color: var(--text-secondary); font-size: 13px; font-weight: 500; margin-bottom: 6px; }
    .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; }
    
    .progress-bar { height: 8px; background: var(--border-light); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--janus-green); transition: width 0.3s; }
    
    .step-indicator { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; }
    .step { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
    .step.active { background: var(--janus-green); color: white; }
    .step.complete { background: var(--success); color: white; }
    .step.pending { background: var(--border-light); color: var(--text-muted); }
    .step-line { flex: 1; height: 2px; background: var(--border-light); }
    .step-line.complete { background: var(--success); }
    
    .mono { font-family: 'JetBrains Mono', monospace; }
    .hidden { display: none !important; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 200; padding: 20px; overflow-y: auto; }
    .modal-content { max-height: 90vh; overflow-y: auto; }
    
    .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-light); padding: 0 24px; position: sticky; top: 0; z-index: 100; }
    .header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 64px; }
    
    .main { max-width: 1400px; margin: 0 auto; padding: 24px; }
    
    .stat-card { padding: 20px; cursor: pointer; transition: all 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
    
    .check-row { display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--bg-primary); border-radius: 6px; margin-bottom: 6px; font-size: 13px; }
    .check-row.pass { border-left: 3px solid var(--success); }
    .check-row.fail { border-left: 3px solid var(--error); }
    
    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr; }
      .header-inner { flex-wrap: wrap; height: auto; padding: 12px 0; gap: 12px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ============================================================================
    // DATA & STATE
    // ============================================================================
    
    const USERS = [
      { id: 'u1', email: 'jbergeron@janusfoodgroup.com', password: 'demo', name: 'Jacob Bergeron', role: 'qa_director', title: 'QA Director', canRelease: true },
      { id: 'u2', email: 'yrivera@janusfoodgroup.com', password: 'demo', name: 'Yamalis Rivera', role: 'qa_manager', title: 'QA Manager', canRelease: true },
      { id: 'u3', email: 'theath@janusfoodgroup.com', password: 'demo', name: 'Tonya Heath', role: 'ops_director', title: 'Operations Director', canRelease: true }
    ];

    let PRODUCTS = [
      { 
        id: 'FG0013', name: 'Classic Chicken Bone Broth Organic', customer: 'Kettle & Fire',
        batchSize: 3900, incubationDays: 10, shelfLife: 24,
        specs: {
          fillWeight: { min: 465, max: 495, unit: 'g' },
          ph: { min: 5.60, max: 6.50 },
          brix: { min: 5.33, max: 5.99 },
          salt: { min: 0.29, max: 0.39 }
        },
        tests: ['ph', 'brix', 'salt'],
        samples: { postRetort: 2, lib: 3, incubation: 1, customer: 3 },
        certifications: ['Gluten Free', 'Organic']
      },
      { 
        id: 'FG0014', name: 'Classic Beef Bone Broth', customer: 'Kettle & Fire',
        batchSize: 3900, incubationDays: 10, shelfLife: 24,
        specs: {
          fillWeight: { min: 465, max: 495, unit: 'g' },
          ph: { min: 5.60, max: 6.85 },
          brix: { min: 4.98, max: 5.62 },
          salt: { min: 0.34, max: 0.41 }
        },
        tests: ['ph', 'brix', 'salt'],
        samples: { postRetort: 1, lib: 1, incubation: 1, customer: 0 },
        certifications: ['Gluten Free']
      }
    ];

    const STATUS = {
      IN_PROGRESS: { id: 'in_progress', label: 'In Process', color: 'info' },
      FILLING: { id: 'filling', label: 'Filling', color: 'warning' },
      INCUBATION: { id: 'incubation', label: 'Incubation Hold', color: 'neutral' },
      PENDING_REVIEW: { id: 'pending_review', label: 'Pending Review', color: 'warning' },
      READY_TO_SHIP: { id: 'ready_to_ship', label: 'Ready to Ship', color: 'success' },
      CANCELLED: { id: 'cancelled', label: 'Cancelled', color: 'error' }
    };

    const SIGNATURE_MEANINGS = [
      'I have performed this task',
      'I have verified this data is accurate',
      'I have reviewed and approve this record',
      'I authorize release of this batch'
    ];

    // App State
    let state = {
      currentUser: null,
      view: 'login',
      selectedBatch: null,
      activeTab: 'inprocess',
      batches: generateInitialBatches(),
      notifications: [],
      productWizardStep: 1,
      newProduct: {}
    };

    function generateInitialBatches() {
      const now = Date.now();
      return [
        {
          id: 'B2026-0001', productId: 'FG0014', status: 'in_progress',
          createdAt: new Date(now - 2*60*60*1000).toISOString(), createdBy: 'u2',
          inProcess: null, 
          filling: { 
            sealChecks: [
              { time: '08:00', carton1: { weight: '478', integrity: 'P', topSeal: '3.2', bottomSeal: '3.1' }, carton2: { weight: '480', integrity: 'P', topSeal: '3.3', bottomSeal: '3.2' }, checkedBy: 'u2', checkedAt: new Date(now - 1.5*60*60*1000).toISOString() },
              { time: '09:00', carton1: { weight: '477', integrity: 'P', topSeal: '3.1', bottomSeal: '3.2' }, carton2: { weight: '479', integrity: 'P', topSeal: '3.2', bottomSeal: '3.1' }, checkedBy: 'u2', checkedAt: new Date(now - 0.5*60*60*1000).toISOString() }
            ], 
            codeChecks: [
              { time: '08:15', code: '2026-033 B1 L1 08:15', legible: 'Y', checkedBy: 'u2', checkedAt: new Date(now - 1.25*60*60*1000).toISOString() },
              { time: '08:45', code: '2026-033 B1 L1 08:45', legible: 'Y', checkedBy: 'u2', checkedAt: new Date(now - 0.75*60*60*1000).toISOString() }
            ], 
            xrayChecks: [
              { time: '08:30', ss: 'P', fe: 'P', nfe: 'P', checkedBy: 'u2', checkedAt: new Date(now - 1*60*60*1000).toISOString() }
            ] 
          },
          postRetort: { tests: [] },
          retorts: [], samples: [], incubation: null,
          auditLog: [{ action: 'Batch Created', userId: 'u2', timestamp: new Date(now - 2*60*60*1000).toISOString() }]
        },
        {
          id: 'B2026-0002', productId: 'FG0013', status: 'incubation',
          createdAt: new Date(now - 8*24*60*60*1000).toISOString(), createdBy: 'u2',
          inProcess: { ph: '6.15', brix: '5.55', salt: '0.32', temp: '148', weight: '3895', organoleptic: 'Pass', taste: 'Pass', release: true, testedBy: 'u1', testedAt: new Date(now - 8*24*60*60*1000).toISOString() },
          filling: { 
            sealChecks: [
              { time: '07:00', carton1: { weight: '476', integrity: 'P', topSeal: '3.2', bottomSeal: '3.0' }, carton2: { weight: '478', integrity: 'P', topSeal: '3.1', bottomSeal: '3.2' }, checkedBy: 'u1', checkedAt: new Date(now - 7.5*24*60*60*1000).toISOString() }
            ], 
            codeChecks: [
              { time: '07:30', code: '2026-025 B2 L1 07:30', legible: 'Y', checkedBy: 'u1', checkedAt: new Date(now - 7.5*24*60*60*1000).toISOString() }
            ], 
            xrayChecks: [
              { time: '07:00', ss: 'P', fe: 'P', nfe: 'P', checkedBy: 'u1', checkedAt: new Date(now - 7.5*24*60*60*1000).toISOString() }
            ] 
          },
          postRetort: { 
            tests: [
              { retortNum: 1, loadNum: 1, cartonTime: '09:15', cartonNum: '0125', flapsSecure: 'Y', sealIntegrity: 'Pass', conductivity: 'Pass', topSeal: '3.2', bottomSeal: '3.1', redInkTest: 'Pass', testedBy: 'u1', testedAt: new Date(now - 7*24*60*60*1000).toISOString() }
            ],
            complete: true, 
            completedBy: 'u1', 
            completedAt: new Date(now - 7*24*60*60*1000).toISOString() 
          },
          retorts: [{ id: 1, loadNum: 1, it: 82, cartons: 1200, startTime: new Date(now - 7.5*24*60*60*1000).toISOString() }],
          samples: [{ type: 'postRetort', retortId: 1, count: 2, pulledBy: 'u1', pulledAt: new Date(now - 7*24*60*60*1000).toISOString() }],
          incubationStartDate: new Date(now - 7*24*60*60*1000).toISOString(),
          incubation: null,
          auditLog: [
            { action: 'Batch Created', userId: 'u2', timestamp: new Date(now - 8*24*60*60*1000).toISOString() },
            { action: 'In-Process Testing Completed', userId: 'u1', timestamp: new Date(now - 8*24*60*60*1000).toISOString(), signature: true },
            { action: 'Post-Retort Testing Completed', userId: 'u1', timestamp: new Date(now - 7*24*60*60*1000).toISOString(), signature: true },
            { action: 'Moved to Incubation Hold', userId: 'u1', timestamp: new Date(now - 7*24*60*60*1000).toISOString(), signature: true }
          ]
        },
        {
          id: 'B2026-0003', productId: 'FG0014', status: 'pending_review',
          createdAt: new Date(now - 15*24*60*60*1000).toISOString(), createdBy: 'u2',
          inProcess: { ph: '6.45', brix: '5.20', salt: '0.38', temp: '150', weight: '3902', organoleptic: 'Pass', taste: 'Pass', release: true, testedBy: 'u1', testedAt: new Date(now - 15*24*60*60*1000).toISOString() },
          filling: { 
            sealChecks: [
              { time: '06:00', carton1: { weight: '479', integrity: 'P', topSeal: '3.3', bottomSeal: '3.2' }, carton2: { weight: '481', integrity: 'P', topSeal: '3.2', bottomSeal: '3.1' }, checkedBy: 'u2', checkedAt: new Date(now - 14.5*24*60*60*1000).toISOString() },
              { time: '07:00', carton1: { weight: '478', integrity: 'P', topSeal: '3.1', bottomSeal: '3.2' }, carton2: { weight: '480', integrity: 'P', topSeal: '3.2', bottomSeal: '3.3' }, checkedBy: 'u2', checkedAt: new Date(now - 14.4*24*60*60*1000).toISOString() }
            ], 
            codeChecks: [
              { time: '06:30', code: '2026-018 B3 L1 06:30', legible: 'Y', checkedBy: 'u2', checkedAt: new Date(now - 14.5*24*60*60*1000).toISOString() }
            ], 
            xrayChecks: [
              { time: '06:30', ss: 'P', fe: 'P', nfe: 'P', checkedBy: 'u2', checkedAt: new Date(now - 14.5*24*60*60*1000).toISOString() },
              { time: '07:00', ss: 'P', fe: 'P', nfe: 'P', checkedBy: 'u2', checkedAt: new Date(now - 14.4*24*60*60*1000).toISOString() }
            ] 
          },
          postRetort: { 
            tests: [
              { retortNum: 1, loadNum: 1, cartonTime: '10:30', cartonNum: '0089', flapsSecure: 'Y', sealIntegrity: 'Pass', conductivity: 'Pass', topSeal: '3.1', bottomSeal: '3.2', redInkTest: 'Pass', testedBy: 'u2', testedAt: new Date(now - 14*24*60*60*1000).toISOString() },
              { retortNum: 1, loadNum: 2, cartonTime: '12:15', cartonNum: '0247', flapsSecure: 'Y', sealIntegrity: 'Pass', conductivity: 'Pass', topSeal: '3.2', bottomSeal: '3.1', redInkTest: 'Pass', testedBy: 'u2', testedAt: new Date(now - 14*24*60*60*1000).toISOString() }
            ],
            complete: true, 
            completedBy: 'u2', 
            completedAt: new Date(now - 14*24*60*60*1000).toISOString() 
          },
          retorts: [{ id: 1, loadNum: 1, it: 85, cartons: 1150, startTime: new Date(now - 14.5*24*60*60*1000).toISOString() }],
          samples: [{ type: 'postRetort', retortId: 1, count: 1, pulledBy: 'u1', pulledAt: new Date(now - 14*24*60*60*1000).toISOString() }],
          incubationStartDate: new Date(now - 14*24*60*60*1000).toISOString(),
          incubation: { ph: '6.40', brix: '5.18', salt: '0.37', containerIntegrity: 'Pass', swelling: 'None', visualDefects: 'None', testedBy: 'u1', testedAt: new Date(now - 4*24*60*60*1000).toISOString() },
          auditLog: [
            { action: 'Batch Created', userId: 'u2', timestamp: new Date(now - 15*24*60*60*1000).toISOString() },
            { action: 'Post-Retort Testing Completed', userId: 'u2', timestamp: new Date(now - 14*24*60*60*1000).toISOString(), signature: true },
            { action: 'Incubation Testing Completed', userId: 'u1', timestamp: new Date(now - 4*24*60*60*1000).toISOString(), signature: true }
          ]
        }
      ];
    }

    // ============================================================================
    // UTILITIES
    // ============================================================================

    function formatDateTime(iso) {
      return new Date(iso).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    
    function formatDate(iso) {
      return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatTime(iso) {
      return new Date(iso).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function getDaysRemaining(startDate, totalDays) {
      return Math.max(0, totalDays - Math.floor((Date.now() - new Date(startDate).getTime()) / (1000 * 60 * 60 * 24)));
    }

    function getDaysSince(startDate) {
      return Math.floor((Date.now() - new Date(startDate).getTime()) / (1000 * 60 * 60 * 24));
    }

    function getUser(id) {
      return USERS.find(u => u.id === id);
    }

    function getProduct(id) {
      return PRODUCTS.find(p => p.id === id);
    }

    function getStatusInfo(statusId) {
      return Object.values(STATUS).find(s => s.id === statusId) || STATUS.IN_PROGRESS;
    }

    function showNotification(message, type = 'info') {
      const id = Date.now();
      state.notifications.push({ id, message, type });
      render();
      setTimeout(() => {
        state.notifications = state.notifications.filter(n => n.id !== id);
        render();
      }, 4000);
    }

    function canUserRelease(user) {
      return user && user.canRelease === true;
    }

    // ============================================================================
    // RENDER FUNCTIONS
    // ============================================================================

    function render() {
      const app = document.getElementById('app');
      
      if (!state.currentUser) {
        app.innerHTML = renderLogin();
      } else if (state.view === 'dashboard') {
        app.innerHTML = renderHeader() + '<main class="main">' + renderDashboard() + '</main>';
      } else if (state.view === 'batches') {
        app.innerHTML = renderHeader() + '<main class="main">' + renderBatchList() + '</main>';
      } else if (state.view === 'batch-detail' && state.selectedBatch) {
        app.innerHTML = renderHeader() + '<main class="main">' + renderBatchDetail() + '</main>';
      } else if (state.view === 'products') {
        app.innerHTML = renderHeader() + '<main class="main">' + renderProducts() + '</main>';
      } else if (state.view === 'new-product') {
        app.innerHTML = renderHeader() + '<main class="main">' + renderProductWizard() + '</main>';
      }
      
      // Notifications
      const notifContainer = document.createElement('div');
      state.notifications.forEach(n => {
        notifContainer.innerHTML += '<div class="notification ' + n.type + '">' + n.message + '</div>';
      });
      app.appendChild(notifContainer);
      
      attachEventListeners();
    }

    function renderLogin() {
      return '\
        <div style="min-height: 100vh; background: linear-gradient(135deg, var(--janus-green) 0%, var(--janus-green-dark) 100%); display: flex; align-items: center; justify-content: center; padding: 20px;">\
          <div class="card" style="width: 420px; max-width: 100%; padding: 40px;">\
            <div style="text-align: center; margin-bottom: 32px;">\
              <div style="width: 64px; height: 64px; background: var(--janus-green); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 28px; font-weight: 700; color: white;">J</div>\
              <h1 style="color: var(--janus-green); font-size: 24px; font-weight: 700; margin-bottom: 4px;">Janus Food Group</h1>\
              <p style="color: var(--text-muted); font-size: 14px;">Quality Management System</p>\
            </div>\
            <div class="form-group">\
              <label class="form-label">Email</label>\
              <input class="input" type="email" id="login-email" placeholder="user@janusfoodgroup.com">\
            </div>\
            <div class="form-group">\
              <label class="form-label">Password</label>\
              <input class="input" type="password" id="login-password" placeholder="••••••••">\
            </div>\
            <div id="login-error" class="hidden" style="color: var(--error); font-size: 14px; margin-bottom: 16px; padding: 12px; background: var(--error-light); border-radius: 8px;"></div>\
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" id="login-btn">Sign In</button>\
            <div style="margin-top: 32px; padding: 20px; background: var(--bg-primary); border-radius: 8px;">\
              <p style="color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase;">Quick Login</p>\
              <div style="display: flex; flex-direction: column; gap: 8px;">\
                ' + USERS.map(function(u) { return '\
                  <button class="quick-login-btn" data-userid="' + u.id + '" style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 8px; padding: 10px 12px; cursor: pointer; width: 100%;">\
                    <span style="color: var(--text-primary); font-weight: 500; font-size: 14px;">' + u.name + '</span>\
                    <span style="color: var(--text-muted); font-size: 12px;">' + u.title + '</span>\
                  </button>\
                '; }).join('') + '\
              </div>\
            </div>\
          </div>\
        </div>\
      ';
    }

    function renderHeader() {
      var user = state.currentUser;
      return '\
        <header class="header">\
          <div class="header-inner">\
            <div style="display: flex; align-items: center; gap: 24px;">\
              <div style="display: flex; align-items: center; gap: 12px;">\
                <div style="width: 36px; height: 36px; background: var(--janus-green); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 18px;">J</div>\
                <div>\
                  <div style="color: var(--text-primary); font-weight: 600; font-size: 15px;">Janus QMS</div>\
                  <div style="color: var(--text-muted); font-size: 11px;">Quality Management</div>\
                </div>\
              </div>\
              <nav style="display: flex; gap: 4px;">\
                <button class="btn btn-ghost nav-btn" data-view="dashboard" style="' + (state.view === 'dashboard' ? 'background: rgba(13,59,45,0.1);' : '') + '">Dashboard</button>\
                <button class="btn btn-ghost nav-btn" data-view="batches" style="' + (state.view === 'batches' || state.view === 'batch-detail' ? 'background: rgba(13,59,45,0.1);' : '') + '">Batches</button>\
                <button class="btn btn-ghost nav-btn" data-view="products" style="' + (state.view === 'products' || state.view === 'new-product' ? 'background: rgba(13,59,45,0.1);' : '') + '">Products</button>\
              </nav>\
            </div>\
            <div style="display: flex; align-items: center; gap: 16px;">\
              <div style="text-align: right;">\
                <div style="color: var(--text-primary); font-weight: 500; font-size: 14px;">' + user.name + '</div>\
                <div style="color: var(--text-muted); font-size: 12px;">' + user.title + '</div>\
              </div>\
              <button class="btn btn-secondary btn-sm" id="logout-btn">Logout</button>\
            </div>\
          </div>\
        </header>\
      ';
    }

    function renderDashboard() {
      var activeBatches = state.batches.filter(function(b) { return b.status === 'in_progress' || b.status === 'filling'; });
      var incubationBatches = state.batches.filter(function(b) { return b.status === 'incubation'; });
      var pendingReview = state.batches.filter(function(b) { return b.status === 'pending_review'; });
      var readyToShip = state.batches.filter(function(b) { return b.status === 'ready_to_ship'; });
      
      return '\
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">\
          <div>\
            <h1 style="color: var(--text-primary); font-size: 28px; font-weight: 700; margin-bottom: 4px;">Dashboard</h1>\
            <p style="color: var(--text-muted);">Quality Management Overview</p>\
          </div>\
          <div style="display: flex; gap: 12px;">\
            <button class="btn btn-secondary" id="new-product-btn">+ New Product</button>\
            <button class="btn btn-primary" id="new-batch-btn">+ New Batch</button>\
          </div>\
        </div>\
        <div class="grid-4" style="margin-bottom: 24px;">\
          <div class="card stat-card card-clickable" data-filter="in_progress" style="border-left: 4px solid var(--info);">\
            <div style="color: var(--text-muted); font-size: 13px; font-weight: 500; margin-bottom: 4px;">Active Production</div>\
            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">' + activeBatches.length + '</div>\
            <div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">Click to view →</div>\
          </div>\
          <div class="card stat-card card-clickable" data-filter="incubation" style="border-left: 4px solid var(--warning);">\
            <div style="color: var(--text-muted); font-size: 13px; font-weight: 500; margin-bottom: 4px;">Incubation Hold</div>\
            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">' + incubationBatches.length + '</div>\
            <div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">Click to view →</div>\
          </div>\
          <div class="card stat-card card-clickable" data-filter="pending_review" style="border-left: 4px solid var(--error);">\
            <div style="color: var(--text-muted); font-size: 13px; font-weight: 500; margin-bottom: 4px;">Pending Review</div>\
            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">' + pendingReview.length + '</div>\
            <div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">Click to view →</div>\
          </div>\
          <div class="card stat-card card-clickable" data-filter="ready_to_ship" style="border-left: 4px solid var(--success);">\
            <div style="color: var(--text-muted); font-size: 13px; font-weight: 500; margin-bottom: 4px;">Ready to Ship</div>\
            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">' + readyToShip.length + '</div>\
            <div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">Click to view →</div>\
          </div>\
        </div>\
        <div class="grid-2" style="gap: 24px;">\
          <div class="card">\
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">\
              <h2 style="color: var(--text-primary); font-size: 16px; font-weight: 600;">Incubation Tracking</h2>\
              <button class="btn btn-ghost btn-sm" data-filter="incubation">View All →</button>\
            </div>\
            <div style="padding: 20px;">\
              ' + (incubationBatches.length === 0 ? '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No batches in incubation</p>' : incubationBatches.map(function(batch) {
                var product = getProduct(batch.productId);
                var daysRemaining = getDaysRemaining(batch.incubationStartDate, product.incubationDays);
                var progress = Math.min(100, (getDaysSince(batch.incubationStartDate) / product.incubationDays) * 100);
                return '\
                  <div class="batch-card card-clickable" data-batchid="' + batch.id + '" style="padding: 16px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 12px; border: 1px solid transparent;">\
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">\
                      <div>\
                        <div style="color: var(--text-primary); font-weight: 600;">' + batch.id + '</div>\
                        <div style="color: var(--text-muted); font-size: 13px;">' + product.name + '</div>\
                      </div>\
                      <div style="text-align: right;">\
                        <div style="color: ' + (daysRemaining <= 2 ? 'var(--success)' : 'var(--text-primary)') + '; font-weight: 700; font-size: 20px;">' + daysRemaining + '</div>\
                        <div style="color: var(--text-muted); font-size: 11px;">days left</div>\
                      </div>\
                    </div>\
                    <div class="progress-bar"><div class="progress-fill" style="width: ' + progress + '%;"></div></div>\
                  </div>\
                ';
              }).join('')) + '\
            </div>\
          </div>\
          <div class="card">\
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">\
              <h2 style="color: var(--text-primary); font-size: 16px; font-weight: 600;">Pending Review</h2>\
              <button class="btn btn-ghost btn-sm" data-filter="pending_review">View All →</button>\
            </div>\
            <div style="padding: 20px;">\
              ' + (pendingReview.length === 0 ? '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No batches pending review</p>' : pendingReview.map(function(batch) {
                var product = getProduct(batch.productId);
                return '\
                  <div class="batch-card card-clickable" data-batchid="' + batch.id + '" style="padding: 16px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 12px; border: 1px solid transparent;">\
                    <div style="display: flex; justify-content: space-between; align-items: center;">\
                      <div>\
                        <div style="color: var(--text-primary); font-weight: 600;">' + batch.id + '</div>\
                        <div style="color: var(--text-muted); font-size: 13px;">' + product.name + '</div>\
                      </div>\
                      <span class="badge badge-warning">Review Required</span>\
                    </div>\
                  </div>\
                ';
              }).join('')) + '\
            </div>\
          </div>\
        </div>\
        ' + (activeBatches.length > 0 ? '\
          <div class="card" style="margin-top: 24px;">\
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">\
              <h2 style="color: var(--text-primary); font-size: 16px; font-weight: 600;">Active Batches</h2>\
              <button class="btn btn-ghost btn-sm" data-filter="in_progress">View All →</button>\
            </div>\
            <table>\
              <thead><tr><th>Batch ID</th><th>Product</th><th>Customer</th><th>Status</th><th>Created</th></tr></thead>\
              <tbody>\
                ' + activeBatches.map(function(batch) {
                  var product = getProduct(batch.productId);
                  var status = getStatusInfo(batch.status);
                  return '\
                    <tr class="batch-row" data-batchid="' + batch.id + '">\
                      <td class="mono" style="font-weight: 600;">' + batch.id + '</td>\
                      <td>' + product.name + '</td>\
                      <td style="color: var(--text-muted);">' + product.customer + '</td>\
                      <td><span class="badge badge-' + status.color + '">' + status.label + '</span></td>\
                      <td style="color: var(--text-muted);">' + formatDateTime(batch.createdAt) + '</td>\
                    </tr>\
                  ';
                }).join('') + '\
              </tbody>\
            </table>\
          </div>\
        ' : '') + '\
        <div id="new-batch-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 500px; max-width: 100%; padding: 32px;">\
            <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">Create New Batch</h2>\
            <div class="form-group">\
              <label class="form-label">Select Product</label>\
              <select class="input" id="new-batch-product">\
                <option value="">Choose a product...</option>\
                ' + PRODUCTS.map(function(p) { return '<option value="' + p.id + '">' + p.id + ' - ' + p.name + '</option>'; }).join('') + '\
              </select>\
            </div>\
            <div id="product-preview"></div>\
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">\
              <button class="btn btn-secondary" id="cancel-new-batch">Cancel</button>\
              <button class="btn btn-primary" id="create-batch-btn" disabled>Create Batch</button>\
            </div>\
          </div>\
        </div>\
      ';
    }

    function renderBatchList() {
      return '\
        <div style="margin-bottom: 24px;">\
          <h1 style="color: var(--text-primary); font-size: 28px; font-weight: 700; margin-bottom: 4px;">Batches</h1>\
          <p style="color: var(--text-muted);">All production batch records</p>\
        </div>\
        <div class="card" style="overflow: hidden;">\
          <table>\
            <thead><tr><th>Batch ID</th><th>Product</th><th>Customer</th><th>Status</th><th>Created</th></tr></thead>\
            <tbody>\
              ' + state.batches.map(function(batch) {
                var product = getProduct(batch.productId);
                var status = getStatusInfo(batch.status);
                return '\
                  <tr class="batch-row" data-batchid="' + batch.id + '">\
                    <td class="mono" style="font-weight: 600;">' + batch.id + '</td>\
                    <td>' + product.name + '</td>\
                    <td style="color: var(--text-muted);">' + product.customer + '</td>\
                    <td><span class="badge badge-' + status.color + '">' + status.label + '</span></td>\
                    <td style="color: var(--text-muted);">' + formatDateTime(batch.createdAt) + '</td>\
                  </tr>\
                ';
              }).join('') + '\
            </tbody>\
          </table>\
        </div>\
      ';
    }

    function renderBatchDetail() {
      var batch = state.selectedBatch;
      var product = getProduct(batch.productId);
      var status = getStatusInfo(batch.status);
      
      var canCancel = batch.status !== 'cancelled' && batch.status !== 'ready_to_ship';
      
      return '\
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">\
          <button class="btn btn-ghost back-btn" style="padding: 8px;">← Back</button>\
          <div style="flex: 1;">\
            <div style="display: flex; align-items: center; gap: 12px;">\
              <h1 style="color: var(--text-primary); font-size: 24px; font-weight: 700;">' + batch.id + '</h1>\
              <span class="badge badge-' + status.color + '">' + status.label + '</span>\
            </div>\
            <p style="color: var(--text-muted);">' + product.name + ' • ' + product.customer + '</p>\
          </div>\
          ' + (canCancel ? '<button class="btn btn-ghost" id="cancel-batch-btn" style="color: var(--error); border: 1px solid var(--error);">Cancel Batch</button>' : '') + '\
        </div>\
        ' + (batch.status === 'cancelled' ? '\
        <div style="padding: 16px 20px; background: var(--error-light); border: 1px solid var(--error); border-radius: 8px; margin-bottom: 24px;">\
          <div style="display: flex; align-items: center; gap: 12px;">\
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--error)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>\
            <div style="flex: 1;">\
              <div style="color: var(--error); font-weight: 600; font-size: 15px;">Batch Cancelled</div>\
              <div style="color: #b91c1c; font-size: 13px; margin-top: 4px;"><strong>Reason:</strong> ' + (batch.cancellationReason || 'No reason provided') + '</div>\
              <div style="color: #92400e; font-size: 12px; margin-top: 4px;">Cancelled by ' + (getUser(batch.cancelledBy) ? getUser(batch.cancelledBy).name : 'Unknown') + ' • Approved by ' + (getUser(batch.cancellationApprovedBy) ? getUser(batch.cancellationApprovedBy).name : 'Unknown') + ' • ' + formatDateTime(batch.cancelledAt) + '</div>\
            </div>\
          </div>\
        </div>\
        ' : '') + '\
        <div class="card" style="padding: 16px; margin-bottom: 24px;">\
          <div class="grid-5" style="font-size: 13px;">\
            <div>\
              <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 2px;">Fill Weight</div>\
              <div class="mono" style="color: var(--text-primary); font-weight: 500;">' + product.specs.fillWeight.min + '-' + product.specs.fillWeight.max + 'g</div>\
            </div>\
            <div>\
              <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 2px;">pH</div>\
              <div class="mono" style="color: var(--text-primary); font-weight: 500;">' + product.specs.ph.min + '-' + product.specs.ph.max + '</div>\
            </div>\
            <div>\
              <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 2px;">Brix</div>\
              <div class="mono" style="color: var(--text-primary); font-weight: 500;">' + product.specs.brix.min + '-' + product.specs.brix.max + '</div>\
            </div>\
            <div>\
              <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 2px;">Salt %</div>\
              <div class="mono" style="color: var(--text-primary); font-weight: 500;">' + product.specs.salt.min + '-' + product.specs.salt.max + '</div>\
            </div>\
            <div>\
              <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 2px;">Incubation</div>\
              <div class="mono" style="color: var(--text-primary); font-weight: 500;">' + product.incubationDays + ' days</div>\
            </div>\
          </div>\
        </div>\
        <div class="card" style="overflow: hidden;">\
          <div class="tabs">\
            <button class="tab detail-tab ' + (state.activeTab === 'inprocess' ? 'active' : '') + '" data-tab="inprocess"><span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-right: 8px; font-size: 12px;">1</span>In-Process</button>\
            <button class="tab detail-tab ' + (state.activeTab === 'filling' ? 'active' : '') + '" data-tab="filling"><span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-right: 8px; font-size: 12px;">2</span>Filling</button>\
            <button class="tab detail-tab ' + (state.activeTab === 'postretort' ? 'active' : '') + '" data-tab="postretort"><span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-right: 8px; font-size: 12px;">3</span>Post-Retort</button>\
            <button class="tab detail-tab ' + (state.activeTab === 'incubation' ? 'active' : '') + '" data-tab="incubation"><span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-right: 8px; font-size: 12px;">4</span>Incubation</button>\
            <button class="tab detail-tab ' + (state.activeTab === 'release' ? 'active' : '') + '" data-tab="release"><span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-right: 8px; font-size: 12px;">5</span>Release</button>\
            <button class="tab detail-tab ' + (state.activeTab === 'audit' ? 'active' : '') + '" data-tab="audit">Audit Log</button>\
          </div>\
          <div style="padding: 24px;">\
            ' + (state.activeTab === 'inprocess' ? renderInProcessTab(batch, product) : '') + '\
            ' + (state.activeTab === 'filling' ? renderFillingTab(batch, product) : '') + '\
            ' + (state.activeTab === 'postretort' ? renderPostRetortTab(batch, product) : '') + '\
            ' + (state.activeTab === 'incubation' ? renderIncubationTab(batch, product) : '') + '\
            ' + (state.activeTab === 'release' ? renderReleaseTab(batch, product) : '') + '\
            ' + (state.activeTab === 'audit' ? renderAuditTab(batch) : '') + '\
          </div>\
        </div>\
        ' + renderSignatureModal() + '\
        ' + renderCancelBatchModal() + '\
      ';
    }
    
    function renderCancelBatchModal() {
      return '\
        <div id="cancel-batch-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 500px; max-width: 100%; padding: 32px;">\
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">\
              <div style="width: 48px; height: 48px; background: var(--error-light); border-radius: 12px; display: flex; align-items: center; justify-content: center;">\
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--error)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>\
              </div>\
              <div>\
                <h2 style="color: var(--error); font-size: 18px; font-weight: 600;">Cancel Batch</h2>\
                <p style="color: var(--text-muted); font-size: 13px;">This action requires supervisor approval</p>\
              </div>\
            </div>\
            <div style="padding: 16px; background: var(--error-light); border-radius: 8px; margin-bottom: 20px;">\
              <div style="color: #b91c1c; font-weight: 600; margin-bottom: 4px;">Warning</div>\
              <div style="color: #92400e; font-size: 13px;">Cancelling a batch is permanent and cannot be undone. All recorded data will be preserved for audit purposes but the batch will be marked as cancelled.</div>\
            </div>\
            <div class="form-group" style="margin-bottom: 16px;">\
              <label class="form-label">Reason for Cancellation *</label>\
              <textarea class="input" id="cancel-reason" rows="3" placeholder="Enter detailed reason for cancelling this batch..."></textarea>\
            </div>\
            <div class="form-group" style="margin-bottom: 16px;">\
              <label class="form-label">Approving Supervisor *</label>\
              <select class="input" id="cancel-supervisor">\
                <option value="">Select supervisor...</option>\
                ' + USERS.filter(function(u) { return u.canRelease; }).map(function(u) { return '<option value="' + u.id + '">' + u.name + ' (' + u.title + ')</option>'; }).join('') + '\
              </select>\
            </div>\
            <div class="form-group" style="margin-bottom: 24px;">\
              <label class="form-label">Supervisor Password *</label>\
              <input class="input" type="password" id="cancel-supervisor-password" placeholder="Enter supervisor password to authorize">\
            </div>\
            <div style="display: flex; gap: 12px; justify-content: flex-end;">\
              <button class="btn btn-secondary" id="cancel-batch-cancel">Go Back</button>\
              <button class="btn" id="cancel-batch-confirm" style="background: var(--error); color: white;">Cancel Batch</button>\
            </div>\
          </div>\
        </div>\
      ';
    }

    function renderInProcessTab(batch, product) {
      var data = batch.inProcess;
      var isComplete = data && data.testedAt;
      var canEdit = !isComplete && batch.status === 'in_progress';
      
      if (isComplete) {
        var tester = getUser(data.testedBy);
        var oosFields = data.oosFields || [];
        var hasOOS = oosFields.length > 0;
        return '\
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">\
            <span class="badge badge-success">✓ Completed</span>\
            <span style="color: var(--text-muted); font-size: 13px;">' + formatDateTime(data.testedAt) + ' by ' + (tester ? tester.name : 'Unknown') + '</span>\
          </div>\
          ' + (data.oosApproval ? '\
          <div style="padding: 12px 16px; background: var(--warning-light); border-radius: 8px; margin-bottom: 20px;">\
            <div style="display: flex; align-items: center; gap: 8px;">\
              <span style="font-size: 18px;">⚠️</span>\
              <span style="color: #b45309; font-weight: 600;">OOS Release Approved</span>\
            </div>\
            <div style="color: #92400e; font-size: 13px; margin-top: 4px;">Fields out of spec: ' + oosFields.join(', ') + '</div>\
            <div style="color: #92400e; font-size: 12px; margin-top: 4px;">Supervisor: ' + (getUser(data.oosApproval.supervisorId) ? getUser(data.oosApproval.supervisorId).name : 'Unknown') + ' at ' + formatDateTime(data.oosApproval.timestamp) + '</div>\
          </div>\
          ' : '') + '\
          ' + (!data.release && data.noReleaseReason ? '\
          <div style="padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px;">\
            <div style="color: var(--text-secondary); font-size: 12px; font-weight: 600; margin-bottom: 4px; text-transform: uppercase;">Reason for No Release</div>\
            <div style="color: var(--text-primary);">' + data.noReleaseReason + '</div>\
          </div>\
          ' : '') + '\
          <div class="grid-4" style="gap: 16px; margin-bottom: 20px;">\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Batch Weight</div>\
              <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">' + data.weight + ' lbs</div>\
            </div>\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Temperature</div>\
              <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">' + data.temp + '°F</div>\
            </div>\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Organoleptic</div>\
              <div style="color: ' + (data.organoleptic === 'Pass' ? 'var(--success)' : 'var(--error)') + '; font-size: 18px; font-weight: 600;">' + data.organoleptic + '</div>\
            </div>\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Taste</div>\
              <div style="color: ' + (data.taste === 'Pass' ? 'var(--success)' : 'var(--error)') + '; font-size: 18px; font-weight: 600;">' + data.taste + '</div>\
            </div>\
          </div>\
          <div class="grid-3" style="gap: 16px; margin-bottom: 20px;">\
            <div style="padding: 16px; background: ' + (isOOS(data.ph, product.specs.ph) ? 'var(--error-light)' : 'var(--bg-primary)') + '; border-radius: 8px; border: 1px solid ' + (isOOS(data.ph, product.specs.ph) ? 'var(--error)' : 'transparent') + ';">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">pH <span style="font-size: 10px;">(' + product.specs.ph.min + '-' + product.specs.ph.max + ')</span></div>\
              <div style="color: ' + (isOOS(data.ph, product.specs.ph) ? 'var(--error)' : 'var(--text-primary)') + '; font-size: 18px; font-weight: 600;">' + data.ph + (isOOS(data.ph, product.specs.ph) ? ' ⚠' : '') + '</div>\
            </div>\
            <div style="padding: 16px; background: ' + (isOOS(data.brix, product.specs.brix) ? 'var(--error-light)' : 'var(--bg-primary)') + '; border-radius: 8px; border: 1px solid ' + (isOOS(data.brix, product.specs.brix) ? 'var(--error)' : 'transparent') + ';">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Brix <span style="font-size: 10px;">(' + product.specs.brix.min + '-' + product.specs.brix.max + ')</span></div>\
              <div style="color: ' + (isOOS(data.brix, product.specs.brix) ? 'var(--error)' : 'var(--text-primary)') + '; font-size: 18px; font-weight: 600;">' + data.brix + (isOOS(data.brix, product.specs.brix) ? ' ⚠' : '') + '</div>\
            </div>\
            <div style="padding: 16px; background: ' + (isOOS(data.salt, product.specs.salt) ? 'var(--error-light)' : 'var(--bg-primary)') + '; border-radius: 8px; border: 1px solid ' + (isOOS(data.salt, product.specs.salt) ? 'var(--error)' : 'transparent') + ';">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Salt % <span style="font-size: 10px;">(' + product.specs.salt.min + '-' + product.specs.salt.max + ')</span></div>\
              <div style="color: ' + (isOOS(data.salt, product.specs.salt) ? 'var(--error)' : 'var(--text-primary)') + '; font-size: 18px; font-weight: 600;">' + data.salt + (isOOS(data.salt, product.specs.salt) ? ' ⚠' : '') + '</div>\
            </div>\
          </div>\
          <div style="padding: 16px; background: ' + (data.release ? 'rgba(16, 185, 129, 0.1)' : 'var(--bg-primary)') + '; border-radius: 8px; border: 1px solid ' + (data.release ? 'var(--success)' : 'var(--border)') + ';">\
            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Released to Fill (TPR2)</div>\
            <div style="color: ' + (data.release ? 'var(--success)' : 'var(--text-primary)') + '; font-size: 18px; font-weight: 600;">' + (data.release ? 'Yes ✓' : 'No') + '</div>\
          </div>\
        ';
      }
      
      return '\
        <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600; margin-bottom: 20px;">In-Process Testing</h3>\
        <div class="grid-2" style="margin-bottom: 24px;">\
          <div class="form-group">\
            <label class="form-label">Batch Weight (lbs) *</label>\
            <input class="input" type="text" id="ip-weight" placeholder="Enter weight" ' + (canEdit ? '' : 'disabled') + '>\
          </div>\
          <div class="form-group">\
            <label class="form-label">Temperature (°F) *</label>\
            <input class="input" type="text" id="ip-temp" placeholder="Enter temp" ' + (canEdit ? '' : 'disabled') + '>\
          </div>\
        </div>\
        <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 16px; text-transform: uppercase;">Critical Factors</h4>\
        <div class="grid-3" style="margin-bottom: 24px;">\
          <div class="form-group">\
            <label class="form-label">pH * <span style="color: var(--text-muted); font-size: 11px;">(' + product.specs.ph.min + '-' + product.specs.ph.max + ')</span></label>\
            <input class="input" type="text" id="ip-ph" placeholder="Enter value" ' + (canEdit ? '' : 'disabled') + '>\
          </div>\
          <div class="form-group">\
            <label class="form-label">Brix * <span style="color: var(--text-muted); font-size: 11px;">(' + product.specs.brix.min + '-' + product.specs.brix.max + ')</span></label>\
            <input class="input" type="text" id="ip-brix" placeholder="Enter value" ' + (canEdit ? '' : 'disabled') + '>\
          </div>\
          <div class="form-group">\
            <label class="form-label">Salt % * <span style="color: var(--text-muted); font-size: 11px;">(' + product.specs.salt.min + '-' + product.specs.salt.max + ')</span></label>\
            <input class="input" type="text" id="ip-salt" placeholder="Enter value" ' + (canEdit ? '' : 'disabled') + '>\
          </div>\
        </div>\
        <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 16px; text-transform: uppercase;">Sensory Evaluation</h4>\
        <div class="grid-2" style="margin-bottom: 24px;">\
          <div class="form-group">\
            <label class="form-label">Organoleptic *</label>\
            <select class="input" id="ip-organo" ' + (canEdit ? '' : 'disabled') + '>\
              <option value="">Select...</option>\
              <option value="Pass">Pass</option>\
              <option value="Fail">Fail</option>\
            </select>\
          </div>\
          <div class="form-group">\
            <label class="form-label">Taste *</label>\
            <select class="input" id="ip-taste" ' + (canEdit ? '' : 'disabled') + '>\
              <option value="">Select...</option>\
              <option value="Pass">Pass</option>\
              <option value="Fail">Fail</option>\
            </select>\
          </div>\
        </div>\
        <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 24px;">\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label" style="font-size: 15px;">Release to Fill? *</label>\
            <select class="input" id="ip-release" style="font-size: 16px; padding: 12px 14px;" ' + (canEdit ? '' : 'disabled') + '>\
              <option value="">Select...</option>\
              <option value="no">No - Do Not Release</option>\
              <option value="yes">Yes - Release to TPR2</option>\
            </select>\
          </div>\
        </div>\
        <div id="ip-validation-error" class="hidden" style="color: var(--error); font-size: 14px; margin-bottom: 16px; padding: 12px; background: var(--error-light); border-radius: 8px;"></div>\
        ' + (canEdit ? '\
          <div style="display: flex; justify-content: flex-end;">\
            <button class="btn btn-primary" id="submit-inprocess">Sign & Submit</button>\
          </div>\
        ' : '') + '\
        ' + renderInProcessModals(product) + '\
      ';
    }
    
    function renderInProcessModals(product) {
      return '\
        <div id="oos-no-release-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 500px; max-width: 100%; padding: 32px;">\
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">\
              <div style="width: 48px; height: 48px; background: var(--warning-light); border-radius: 12px; display: flex; align-items: center; justify-content: center;">\
                <span style="font-size: 24px;">⚠️</span>\
              </div>\
              <div>\
                <h2 style="color: var(--text-primary); font-size: 18px; font-weight: 600;">Out of Specification Detected</h2>\
                <p style="color: var(--text-muted); font-size: 13px;">Release set to No</p>\
              </div>\
            </div>\
            <div id="oos-fields-list" style="padding: 16px; background: var(--error-light); border-radius: 8px; margin-bottom: 20px;"></div>\
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">Please confirm that the reason for not releasing is due to the out-of-specification result(s) listed above.</p>\
            <div style="display: flex; gap: 12px;">\
              <button class="btn btn-secondary" style="flex: 1;" id="cancel-oos-no">Cancel</button>\
              <button class="btn btn-warning" style="flex: 1;" id="confirm-oos-no">Confirm & Continue</button>\
            </div>\
          </div>\
        </div>\
        <div id="no-release-reason-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 500px; max-width: 100%; padding: 32px;">\
            <h2 style="color: var(--text-primary); font-size: 18px; font-weight: 600; margin-bottom: 8px;">Reason Required</h2>\
            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 20px;">All test results are within specification but release is set to No. Please provide a reason.</p>\
            <div class="form-group">\
              <label class="form-label">Reason for Not Releasing *</label>\
              <textarea class="input" id="no-release-reason" placeholder="Enter reason..." style="min-height: 100px;"></textarea>\
            </div>\
            <div style="display: flex; gap: 12px;">\
              <button class="btn btn-secondary" style="flex: 1;" id="cancel-no-release">Cancel</button>\
              <button class="btn btn-primary" style="flex: 1;" id="confirm-no-release">Continue</button>\
            </div>\
          </div>\
        </div>\
        <div id="oos-yes-release-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 500px; max-width: 100%; padding: 32px;">\
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">\
              <div style="width: 48px; height: 48px; background: var(--error-light); border-radius: 12px; display: flex; align-items: center; justify-content: center;">\
                <span style="font-size: 24px;">🚨</span>\
              </div>\
              <div>\
                <h2 style="color: var(--error); font-size: 18px; font-weight: 600;">OOS Release Warning</h2>\
                <p style="color: var(--text-muted); font-size: 13px;">Supervisor Approval Required</p>\
              </div>\
            </div>\
            <div id="oos-release-fields-list" style="padding: 16px; background: var(--error-light); border-radius: 8px; margin-bottom: 20px;"></div>\
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">You are attempting to release a batch with out-of-specification results. This requires supervisor approval.</p>\
            <div style="display: flex; gap: 12px;">\
              <button class="btn btn-secondary" style="flex: 1;" id="cancel-oos-yes">Cancel</button>\
              <button class="btn btn-danger" style="flex: 1;" id="confirm-oos-yes">Proceed to Supervisor Approval</button>\
            </div>\
          </div>\
        </div>\
        <div id="supervisor-approval-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 500px; max-width: 100%; padding: 32px;">\
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">\
              <div style="width: 48px; height: 48px; background: var(--janus-green); border-radius: 12px; display: flex; align-items: center; justify-content: center;">\
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>\
              </div>\
              <div>\
                <h2 style="color: var(--text-primary); font-size: 18px; font-weight: 600;">Supervisor Approval</h2>\
                <p style="color: var(--text-muted); font-size: 13px;">QA Director, QA Manager, or Operations Director</p>\
              </div>\
            </div>\
            <div style="padding: 16px; background: var(--warning-light); border-radius: 8px; margin-bottom: 20px;">\
              <div style="color: #92400e; font-weight: 600; margin-bottom: 4px;">OOS Release Authorization</div>\
              <div id="supervisor-oos-summary" style="color: #92400e; font-size: 13px;"></div>\
            </div>\
            <div class="form-group">\
              <label class="form-label">Supervisor</label>\
              <select class="input" id="supervisor-select">\
                <option value="">Select supervisor...</option>\
                ' + USERS.filter(function(u) { return u.canRelease; }).map(function(u) { return '<option value="' + u.id + '">' + u.name + ' (' + u.title + ')</option>'; }).join('') + '\
              </select>\
            </div>\
            <div class="form-group">\
              <label class="form-label">Supervisor Password *</label>\
              <input class="input" type="password" id="supervisor-password" placeholder="Enter supervisor password">\
            </div>\
            <div id="supervisor-error" class="hidden" style="color: var(--error); font-size: 14px; margin-bottom: 16px; padding: 12px; background: var(--error-light); border-radius: 8px;"></div>\
            <div style="display: flex; gap: 12px;">\
              <button class="btn btn-secondary" style="flex: 1;" id="cancel-supervisor">Cancel</button>\
              <button class="btn btn-success" style="flex: 1;" id="confirm-supervisor">Approve & Release</button>\
            </div>\
          </div>\
        </div>\
      ';
    }
    
    function isOOS(value, spec) {
      if (!value || !spec) return false;
      var num = parseFloat(value);
      if (isNaN(num)) return false;
      return num < spec.min || num > spec.max;
    }
    
    function getOOSItems(data, product) {
      var items = [];
      if (isOOS(data.ph, product.specs.ph)) {
        items.push({ field: 'pH', value: data.ph, spec: product.specs.ph.min + '-' + product.specs.ph.max });
      }
      if (isOOS(data.brix, product.specs.brix)) {
        items.push({ field: 'Brix', value: data.brix, spec: product.specs.brix.min + '-' + product.specs.brix.max });
      }
      if (isOOS(data.salt, product.specs.salt)) {
        items.push({ field: 'Salt %', value: data.salt, spec: product.specs.salt.min + '-' + product.specs.salt.max });
      }
      if (data.organoleptic === 'Fail') {
        items.push({ field: 'Organoleptic', value: 'Fail', spec: 'Pass' });
      }
      if (data.taste === 'Fail') {
        items.push({ field: 'Taste', value: 'Fail', spec: 'Pass' });
      }
      return items;
    }

    function renderFillingTab(batch, product) {
      var sealChecks = batch.filling.sealChecks || [];
      var codeChecks = batch.filling.codeChecks || [];
      var xrayChecks = batch.filling.xrayChecks || [];
      
      // Filling only available after in-process release
      var inProcessComplete = batch.inProcess && batch.inProcess.release === true;
      
      if (!inProcessComplete) {
        return '\
          <div style="text-align: center; padding: 40px;">\
            <div style="width: 64px; height: 64px; background: var(--bg-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">\
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>\
            </div>\
            <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600; margin-bottom: 8px;">Awaiting In-Process Release</h3>\
            <p style="color: var(--text-muted); font-size: 14px;">Filling checks begin after batch passes In-Process Testing and is released to TPR2 for filling.</p>\
          </div>\
        ';
      }
      
      var canAddChecks = batch.status === 'in_progress' || batch.status === 'filling';
      
      return '\
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">\
          <div>\
            <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600;">TPR2 Filling Quality Checks</h3>\
            <p style="color: var(--text-muted); font-size: 13px;">Released to fill: ' + formatDateTime(batch.inProcess.testedAt) + '</p>\
          </div>\
          <div style="display: flex; gap: 8px;">\
            <span class="badge badge-' + (sealChecks.length > 0 ? 'success' : 'neutral') + '">Seal: ' + sealChecks.length + '</span>\
            <span class="badge badge-' + (codeChecks.length > 0 ? 'success' : 'neutral') + '">Code: ' + codeChecks.length + '</span>\
            <span class="badge badge-' + (xrayChecks.length > 0 ? 'success' : 'neutral') + '">X-Ray: ' + xrayChecks.length + '</span>\
          </div>\
        </div>\
        ' + (canAddChecks ? '\
        <div style="display: flex; gap: 8px; margin-bottom: 24px;">\
          <button class="btn btn-primary btn-sm" id="add-seal-check">+ Seal Check</button>\
          <button class="btn btn-primary btn-sm" id="add-code-check">+ Code Audit</button>\
          <button class="btn btn-primary btn-sm" id="add-xray-check">+ X-Ray Check</button>\
        </div>\
        ' : '') + '\
        <div class="grid-3" style="gap: 24px;">\
          <div>\
            <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">Seal Checks <span style="font-weight: 400; color: var(--text-muted);">(Hourly)</span></h4>\
            ' + (sealChecks.length === 0 ? '<p style="color: var(--text-muted); font-size: 13px; padding: 12px; background: var(--bg-primary); border-radius: 6px;">No checks recorded</p>' : sealChecks.map(function(c) {
              var checker = getUser(c.checkedBy);
              return '\
                <div class="check-row pass" style="flex-direction: column; align-items: flex-start; gap: 4px;">\
                  <div style="display: flex; justify-content: space-between; width: 100%;">\
                    <span style="font-weight: 600;">' + c.time + '</span>\
                    <span style="color: var(--success);">✓ Pass</span>\
                  </div>\
                  <div style="font-size: 12px; color: var(--text-muted);">C1: ' + c.carton1.weight + 'g, Top: ' + c.carton1.topSeal + 'mm</div>\
                  <div style="font-size: 12px; color: var(--text-muted);">C2: ' + c.carton2.weight + 'g, Top: ' + c.carton2.topSeal + 'mm</div>\
                  <div style="font-size: 11px; color: var(--text-muted);">' + (checker ? checker.name : '') + '</div>\
                </div>\
              ';
            }).join('')) + '\
          </div>\
          <div>\
            <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">Code Audit <span style="font-weight: 400; color: var(--text-muted);">(Every 30 min)</span></h4>\
            ' + (codeChecks.length === 0 ? '<p style="color: var(--text-muted); font-size: 13px; padding: 12px; background: var(--bg-primary); border-radius: 6px;">No checks recorded</p>' : codeChecks.map(function(c) {
              var checker = getUser(c.checkedBy);
              return '\
                <div class="check-row pass" style="flex-direction: column; align-items: flex-start; gap: 4px;">\
                  <div style="display: flex; justify-content: space-between; width: 100%;">\
                    <span style="font-weight: 600;">' + c.time + '</span>\
                    <span style="color: var(--success);">✓ Legible</span>\
                  </div>\
                  <div class="mono" style="font-size: 11px; color: var(--text-secondary);">' + c.code + '</div>\
                  <div style="font-size: 11px; color: var(--text-muted);">' + (checker ? checker.name : '') + '</div>\
                </div>\
              ';
            }).join('')) + '\
          </div>\
          <div>\
            <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">X-Ray Verification <span style="font-weight: 400; color: var(--text-muted);">(Every 30 min)</span></h4>\
            ' + (xrayChecks.length === 0 ? '<p style="color: var(--text-muted); font-size: 13px; padding: 12px; background: var(--bg-primary); border-radius: 6px;">No checks recorded</p>' : xrayChecks.map(function(c) {
              var checker = getUser(c.checkedBy);
              return '\
                <div class="check-row pass" style="flex-direction: column; align-items: flex-start; gap: 4px;">\
                  <div style="display: flex; justify-content: space-between; width: 100%;">\
                    <span style="font-weight: 600;">' + c.time + '</span>\
                    <span style="color: var(--success);">✓ 3/3 Pass</span>\
                  </div>\
                  <div style="font-size: 12px; color: var(--text-muted);">SS: ' + c.ss + ' | Fe: ' + c.fe + ' | NFe: ' + c.nfe + '</div>\
                  <div style="font-size: 11px; color: var(--text-muted);">' + (checker ? checker.name : '') + '</div>\
                </div>\
              ';
            }).join('')) + '\
          </div>\
        </div>\
        ' + renderFillingModals() + '\
      ';
    }
    
    function renderFillingModals() {
      return '\
        <div id="seal-check-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 600px; max-width: 100%; padding: 32px;">\
            <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">Seal Check (2 Cartons)</h2>\
            <div class="form-group">\
              <label class="form-label">Time</label>\
              <input class="input" type="time" id="seal-time">\
            </div>\
            <div class="grid-2" style="gap: 24px; margin-bottom: 20px;">\
              <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
                <h4 style="color: var(--text-secondary); font-size: 13px; font-weight: 600; margin-bottom: 12px;">Carton 1</h4>\
                <div class="form-group"><label class="form-label">Weight (g)</label><input class="input" type="text" id="seal-c1-weight" placeholder="Enter weight"></div>\
                <div class="form-group"><label class="form-label">Integrity</label><select class="input" id="seal-c1-integrity"><option value="P">Pass</option><option value="F">Fail</option></select></div>\
                <div class="grid-2"><div class="form-group"><label class="form-label">Top Seal (mm)</label><input class="input" type="text" id="seal-c1-top" placeholder="Enter value"></div><div class="form-group"><label class="form-label">Bottom Seal (mm)</label><input class="input" type="text" id="seal-c1-bottom" placeholder="Enter value"></div></div>\
              </div>\
              <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
                <h4 style="color: var(--text-secondary); font-size: 13px; font-weight: 600; margin-bottom: 12px;">Carton 2</h4>\
                <div class="form-group"><label class="form-label">Weight (g)</label><input class="input" type="text" id="seal-c2-weight" placeholder="Enter weight"></div>\
                <div class="form-group"><label class="form-label">Integrity</label><select class="input" id="seal-c2-integrity"><option value="P">Pass</option><option value="F">Fail</option></select></div>\
                <div class="grid-2"><div class="form-group"><label class="form-label">Top Seal (mm)</label><input class="input" type="text" id="seal-c2-top" placeholder="Enter value"></div><div class="form-group"><label class="form-label">Bottom Seal (mm)</label><input class="input" type="text" id="seal-c2-bottom" placeholder="Enter value"></div></div>\
              </div>\
            </div>\
            <div style="display: flex; gap: 12px; justify-content: flex-end;">\
              <button class="btn btn-secondary" id="cancel-seal-check">Cancel</button>\
              <button class="btn btn-primary" id="save-seal-check">Save Check</button>\
            </div>\
          </div>\
        </div>\
        <div id="code-check-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 450px; max-width: 100%; padding: 32px;">\
            <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">Carton Code Audit</h2>\
            <div class="form-group"><label class="form-label">Time</label><input class="input" type="time" id="code-time"></div>\
            <div class="form-group"><label class="form-label">Code (copy from carton)</label><input class="input" type="text" id="code-value" placeholder="Enter code from carton"></div>\
            <div class="form-group"><label class="form-label">Legible?</label><select class="input" id="code-legible"><option value="Y">Yes</option><option value="N">No</option></select></div>\
            <div style="display: flex; gap: 12px; justify-content: flex-end;">\
              <button class="btn btn-secondary" id="cancel-code-check">Cancel</button>\
              <button class="btn btn-primary" id="save-code-check">Save Check</button>\
            </div>\
          </div>\
        </div>\
        <div id="xray-check-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 450px; max-width: 100%; padding: 32px;">\
            <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">X-Ray Verification</h2>\
            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 20px;">Verify 3/3 test pieces rejected: 1.5mm SS, 2.0mm Fe, 2.0mm NFe</p>\
            <div class="form-group"><label class="form-label">Time</label><input class="input" type="time" id="xray-time"></div>\
            <div class="grid-3" style="margin-bottom: 20px;">\
              <div class="form-group"><label class="form-label">1.5mm SS</label><select class="input" id="xray-ss"><option value="P">Pass (Rejected)</option><option value="F">Fail</option></select></div>\
              <div class="form-group"><label class="form-label">2.0mm Fe</label><select class="input" id="xray-fe"><option value="P">Pass (Rejected)</option><option value="F">Fail</option></select></div>\
              <div class="form-group"><label class="form-label">2.0mm NFe</label><select class="input" id="xray-nfe"><option value="P">Pass (Rejected)</option><option value="F">Fail</option></select></div>\
            </div>\
            <div style="display: flex; gap: 12px; justify-content: flex-end;">\
              <button class="btn btn-secondary" id="cancel-xray-check">Cancel</button>\
              <button class="btn btn-primary" id="save-xray-check">Save Check</button>\
            </div>\
          </div>\
        </div>\
      ';
    }

    function renderPostRetortTab(batch, product) {
      var postRetort = batch.postRetort || { tests: [] };
      var tests = postRetort.tests || [];
      var isComplete = postRetort.complete === true;
      
      // Post-retort testing is available after filling is done (retort process complete)
      var fillingDone = batch.filling && batch.filling.sealChecks && batch.filling.sealChecks.length > 0;
      
      if (!fillingDone) {
        return '\
          <div style="text-align: center; padding: 40px;">\
            <div style="width: 64px; height: 64px; background: var(--bg-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">\
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>\
            </div>\
            <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600; margin-bottom: 8px;">Awaiting Filling Completion</h3>\
            <p style="color: var(--text-muted); font-size: 14px;">Post-retort testing begins after filling and retort processing is complete.</p>\
          </div>\
        ';
      }
      
      if (isComplete) {
        var tester = getUser(postRetort.completedBy);
        return '\
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">\
            <span class="badge badge-success">✓ Completed</span>\
            <span style="color: var(--text-muted); font-size: 13px;">' + formatDateTime(postRetort.completedAt) + ' by ' + (tester ? tester.name : 'Unknown') + '</span>\
          </div>\
          <h3 style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-bottom: 16px;">Post-Retort Seal Integrity Tests (' + tests.length + ')</h3>\
          <div style="display: flex; flex-direction: column; gap: 12px;">\
            ' + tests.map(function(t, i) {
              var checker = getUser(t.testedBy);
              return '\
                <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; border-left: 3px solid var(--success);">\
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">\
                    <div>\
                      <div style="font-weight: 600; color: var(--text-primary);">Retort #' + t.retortNum + ' / Load #' + t.loadNum + '</div>\
                      <div style="color: var(--text-muted); font-size: 12px;">Carton: ' + t.cartonNum + ' @ ' + t.cartonTime + '</div>\
                    </div>\
                    <span class="badge badge-success">✓ Pass</span>\
                  </div>\
                  <div class="grid-3" style="gap: 12px; font-size: 13px;">\
                    <div><span style="color: var(--text-muted);">Flaps Secure:</span> <span style="color: var(--text-primary);">' + t.flapsSecure + '</span></div>\
                    <div><span style="color: var(--text-muted);">Seal Integrity:</span> <span style="color: var(--success);">' + t.sealIntegrity + '</span></div>\
                    <div><span style="color: var(--text-muted);">Conductivity:</span> <span style="color: var(--success);">' + t.conductivity + '</span></div>\
                    <div><span style="color: var(--text-muted);">Top Seal:</span> <span style="color: var(--text-primary);">' + t.topSeal + 'mm</span></div>\
                    <div><span style="color: var(--text-muted);">Bottom Seal:</span> <span style="color: var(--text-primary);">' + t.bottomSeal + 'mm</span></div>\
                    <div><span style="color: var(--text-muted);">Red Ink Test:</span> <span style="color: var(--success);">' + t.redInkTest + '</span></div>\
                  </div>\
                  <div style="color: var(--text-muted); font-size: 11px; margin-top: 8px;">' + (checker ? checker.name : '') + ' • ' + formatDateTime(t.testedAt) + '</div>\
                </div>\
              ';
            }).join('') + '\
          </div>\
        ';
      }
      
      var canAddTest = batch.status === 'filling' || batch.status === 'in_progress';
      
      return '\
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">\
          <div>\
            <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600;">Post-Retort Seal Integrity Testing</h3>\
            <p style="color: var(--text-muted); font-size: 13px;">Test cartons from each retort load before incubation</p>\
          </div>\
          <span class="badge badge-' + (tests.length > 0 ? 'success' : 'neutral') + '">Tests: ' + tests.length + '</span>\
        </div>\
        ' + (canAddTest ? '\
        <div style="display: flex; gap: 8px; margin-bottom: 24px;">\
          <button class="btn btn-primary" id="add-postretort-test">+ Add Test</button>\
          ' + (tests.length > 0 ? '<button class="btn btn-success" id="complete-postretort">Complete & Move to Incubation</button>' : '') + '\
        </div>\
        ' : '') + '\
        ' + (tests.length === 0 ? '\
        <div style="text-align: center; padding: 40px; background: var(--bg-primary); border-radius: 8px;">\
          <p style="color: var(--text-muted);">No post-retort tests recorded yet.</p>\
          <p style="color: var(--text-muted); font-size: 13px; margin-top: 8px;">Add a test for each retort load.</p>\
        </div>\
        ' : '\
        <div style="display: flex; flex-direction: column; gap: 12px;">\
          ' + tests.map(function(t, i) {
            var checker = getUser(t.testedBy);
            return '\
              <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; border-left: 3px solid var(--success);">\
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">\
                  <div>\
                    <div style="font-weight: 600; color: var(--text-primary);">Retort #' + t.retortNum + ' / Load #' + t.loadNum + '</div>\
                    <div style="color: var(--text-muted); font-size: 12px;">Carton: ' + t.cartonNum + ' @ ' + t.cartonTime + '</div>\
                  </div>\
                  <span class="badge badge-success">✓ Pass</span>\
                </div>\
                <div class="grid-3" style="gap: 12px; font-size: 13px;">\
                  <div><span style="color: var(--text-muted);">Flaps Secure:</span> <span style="color: var(--text-primary);">' + t.flapsSecure + '</span></div>\
                  <div><span style="color: var(--text-muted);">Seal Integrity:</span> <span style="color: var(--success);">' + t.sealIntegrity + '</span></div>\
                  <div><span style="color: var(--text-muted);">Conductivity:</span> <span style="color: var(--success);">' + t.conductivity + '</span></div>\
                  <div><span style="color: var(--text-muted);">Top Seal:</span> <span style="color: var(--text-primary);">' + t.topSeal + 'mm</span></div>\
                  <div><span style="color: var(--text-muted);">Bottom Seal:</span> <span style="color: var(--text-primary);">' + t.bottomSeal + 'mm</span></div>\
                  <div><span style="color: var(--text-muted);">Red Ink Test:</span> <span style="color: var(--success);">' + t.redInkTest + '</span></div>\
                </div>\
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 8px;">' + (checker ? checker.name : '') + ' • ' + formatDateTime(t.testedAt) + '</div>\
              </div>\
            ';
          }).join('') + '\
        </div>\
        ') + '\
        ' + renderPostRetortModal() + '\
      ';
    }
    
    function renderPostRetortModal() {
      return '\
        <div id="postretort-test-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 550px; max-width: 100%; padding: 32px;">\
            <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">Post-Retort Seal Integrity Test</h2>\
            <div class="grid-2" style="gap: 16px; margin-bottom: 20px;">\
              <div class="form-group">\
                <label class="form-label">Retort # *</label>\
                <input class="input" type="text" id="pr-retort-num" placeholder="Enter retort number">\
              </div>\
              <div class="form-group">\
                <label class="form-label">Load # *</label>\
                <input class="input" type="text" id="pr-load-num" placeholder="Enter load number">\
              </div>\
            </div>\
            <div class="grid-2" style="gap: 16px; margin-bottom: 20px;">\
              <div class="form-group">\
                <label class="form-label">Carton Time *</label>\
                <input class="input" type="time" id="pr-carton-time">\
              </div>\
              <div class="form-group">\
                <label class="form-label">Carton Number *</label>\
                <input class="input" type="text" id="pr-carton-num" placeholder="Enter carton #">\
              </div>\
            </div>\
            <div class="grid-2" style="gap: 16px; margin-bottom: 20px;">\
              <div class="form-group">\
                <label class="form-label">Flaps Secure *</label>\
                <select class="input" id="pr-flaps">\
                  <option value="">Select...</option>\
                  <option value="Y">Yes</option>\
                  <option value="N">No</option>\
                </select>\
              </div>\
              <div class="form-group">\
                <label class="form-label">Seal Integrity *</label>\
                <select class="input" id="pr-integrity">\
                  <option value="">Select...</option>\
                  <option value="Pass">Pass</option>\
                  <option value="Fail">Fail</option>\
                </select>\
              </div>\
            </div>\
            <div class="grid-2" style="gap: 16px; margin-bottom: 20px;">\
              <div class="form-group">\
                <label class="form-label">Conductivity *</label>\
                <select class="input" id="pr-conductivity">\
                  <option value="">Select...</option>\
                  <option value="Pass">Pass</option>\
                  <option value="Fail">Fail</option>\
                </select>\
              </div>\
              <div class="form-group">\
                <label class="form-label">Red Ink Test *</label>\
                <select class="input" id="pr-redink">\
                  <option value="">Select...</option>\
                  <option value="Pass">Pass</option>\
                  <option value="Fail">Fail</option>\
                </select>\
              </div>\
            </div>\
            <div class="grid-2" style="gap: 16px; margin-bottom: 24px;">\
              <div class="form-group">\
                <label class="form-label">Top Seal Width (mm) *</label>\
                <input class="input" type="text" id="pr-top-seal" placeholder="Enter value">\
              </div>\
              <div class="form-group">\
                <label class="form-label">Bottom Seal Width (mm) *</label>\
                <input class="input" type="text" id="pr-bottom-seal" placeholder="Enter value">\
              </div>\
            </div>\
            <div style="display: flex; gap: 12px; justify-content: flex-end;">\
              <button class="btn btn-secondary" id="cancel-postretort-test">Cancel</button>\
              <button class="btn btn-primary" id="save-postretort-test">Save Test</button>\
            </div>\
          </div>\
        </div>\
      ';
    }

    function renderIncubationTab(batch, product) {
      if (!batch.incubationStartDate) {
        return '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Batch has not entered incubation hold yet.</div>';
      }
      
      var daysRemaining = getDaysRemaining(batch.incubationStartDate, product.incubationDays);
      var daysSince = getDaysSince(batch.incubationStartDate);
      var progress = Math.min(100, (daysSince / product.incubationDays) * 100);
      var canTest = daysRemaining === 0 && !batch.incubation;
      
      if (batch.incubation) {
        var tester = getUser(batch.incubation.testedBy);
        return '\
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">\
            <span class="badge badge-success">✓ Testing Complete</span>\
            <span style="color: var(--text-muted); font-size: 13px;">' + formatDateTime(batch.incubation.testedAt) + ' by ' + (tester ? tester.name : 'Unknown') + '</span>\
          </div>\
          <div class="grid-3" style="gap: 16px;">\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">pH</div>\
              <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">' + batch.incubation.ph + '</div>\
            </div>\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Brix</div>\
              <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">' + batch.incubation.brix + '</div>\
            </div>\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Container Integrity</div>\
              <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">' + batch.incubation.containerIntegrity + '</div>\
            </div>\
          </div>\
        ';
      }
      
      return '\
        <div style="padding: 20px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 24px;">\
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">\
            <div>\
              <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600;">' + product.incubationDays + '-Day Incubation Hold</h3>\
              <p style="color: var(--text-muted); font-size: 13px;">Started: ' + formatDateTime(batch.incubationStartDate) + '</p>\
            </div>\
            ' + (daysRemaining === 0 ? '<span class="badge badge-success">Ready for Testing</span>' : '\
              <div style="text-align: right;">\
                <div style="font-size: 28px; font-weight: 700; color: var(--janus-green);">' + daysRemaining + '</div>\
                <div style="color: var(--text-muted); font-size: 12px;">days remaining</div>\
              </div>\
            ') + '\
          </div>\
          <div class="progress-bar" style="height: 10px;"><div class="progress-fill" style="width: ' + progress + '%;"></div></div>\
          <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-muted);">\
            <span>Day ' + daysSince + ' of ' + product.incubationDays + '</span>\
          </div>\
        </div>\
        ' + (canTest ? '\
          <h3 style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-bottom: 20px;">Incubation Testing</h3>\
          <div class="grid-3" style="margin-bottom: 20px;">\
            <div class="form-group">\
              <label class="form-label">pH</label>\
              <input class="input" type="text" id="inc-ph">\
            </div>\
            <div class="form-group">\
              <label class="form-label">Brix</label>\
              <input class="input" type="text" id="inc-brix">\
            </div>\
            <div class="form-group">\
              <label class="form-label">Salt %</label>\
              <input class="input" type="text" id="inc-salt">\
            </div>\
          </div>\
          <div class="grid-3" style="margin-bottom: 20px;">\
            <div class="form-group">\
              <label class="form-label">Container Integrity</label>\
              <select class="input" id="inc-integrity">\
                <option value="">Select</option>\
                <option value="Pass">Pass</option>\
                <option value="Fail">Fail</option>\
              </select>\
            </div>\
            <div class="form-group">\
              <label class="form-label">Swelling</label>\
              <select class="input" id="inc-swelling">\
                <option value="">Select</option>\
                <option value="None">None</option>\
                <option value="Slight">Slight</option>\
                <option value="Moderate">Moderate</option>\
              </select>\
            </div>\
            <div class="form-group">\
              <label class="form-label">Visual Defects</label>\
              <select class="input" id="inc-defects">\
                <option value="">Select</option>\
                <option value="None">None</option>\
                <option value="Minor">Minor</option>\
                <option value="Major">Major</option>\
              </select>\
            </div>\
          </div>\
          <div style="display: flex; justify-content: flex-end;">\
            <button class="btn btn-primary" id="submit-incubation">Sign & Submit for Review</button>\
          </div>\
        ' : '<div style="padding: 20px; background: var(--warning-light); border-radius: 8px; color: #92400e; font-size: 13px;">Incubation period not yet complete. Testing available when hold period ends.</div>') + '\
      ';
    }

    function renderReleaseTab(batch, product) {
      if (batch.status === 'ready_to_ship') {
        var releaser = getUser(batch.release.releasedBy);
        return '\
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">\
            <div style="width: 48px; height: 48px; background: var(--success-light); border-radius: 12px; display: flex; align-items: center; justify-content: center;">\
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>\
            </div>\
            <div>\
              <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600;">Batch Released</h3>\
              <p style="color: var(--text-muted); font-size: 13px;">' + formatDateTime(batch.release.releasedAt) + ' by ' + (releaser ? releaser.name : 'Unknown') + '</p>\
            </div>\
          </div>\
          <div style="padding: 24px; background: white; border: 1px solid var(--border-light); border-radius: 8px;">\
            <div style="text-align: center; border-bottom: 2px solid var(--janus-green); padding-bottom: 16px; margin-bottom: 20px;">\
              <h2 style="color: var(--janus-green); font-size: 20px; font-weight: 700;">CERTIFICATE OF ANALYSIS</h2>\
              <p style="color: var(--text-muted); font-size: 13px;">Janus Food Group</p>\
            </div>\
            <div class="grid-2" style="gap: 20px; margin-bottom: 20px;">\
              <div>\
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Product</div>\
                <div style="font-weight: 600;">' + product.name + '</div>\
                <div style="color: var(--text-muted); font-size: 13px;">' + product.id + ' • ' + product.customer + '</div>\
              </div>\
              <div>\
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Batch</div>\
                <div style="font-weight: 600;">' + batch.id + '</div>\
                <div style="color: var(--text-muted); font-size: 13px;">Released: ' + formatDate(batch.release.releasedAt) + '</div>\
              </div>\
            </div>\
            <div style="padding: 12px; background: var(--success-light); border-radius: 6px; text-align: center;">\
              <span style="color: #047857; font-weight: 600;">✓ All Quality Checks Passed</span>\
            </div>\
          </div>\
        ';
      }
      
      var canRelease = canUserRelease(state.currentUser) && batch.status === 'pending_review' && batch.incubation;
      var checkItems = ['Product is commercially sterile', 'Product is food safe', 'Product meets Process Letter requirements', 'Product passed finished goods testing', 'Product passed incubation testing', 'Pre-shipment review is completed', 'Product meets customer specifications'];
      
      return '\
        <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600; margin-bottom: 8px;">Positive Release Form</h3>\
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 24px;">Complete all checklist items to release batch.</p>\
        ' + (!canRelease && batch.status !== 'pending_review' ? '<div style="padding: 16px; background: var(--warning-light); border-radius: 8px; color: #92400e; font-size: 13px; margin-bottom: 24px;">Batch must complete incubation testing before release.</div>' : '') + '\
        ' + (!canUserRelease(state.currentUser) && batch.status === 'pending_review' ? '<div style="padding: 16px; background: var(--info); border-radius: 8px; color: white; font-size: 13px; margin-bottom: 24px;">Only QA Director, QA Manager, or Operations Director can release batches.</div>' : '') + '\
        <div style="margin-bottom: 24px;">\
          ' + checkItems.map(function(item, i) { return '\
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; cursor: ' + (canRelease ? 'pointer' : 'default') + ';">\
              <input type="checkbox" class="release-check" data-index="' + i + '" style="width: 18px; height: 18px;" ' + (canRelease ? '' : 'disabled') + '>\
              <span style="color: var(--text-primary); font-weight: 500;">' + item + '</span>\
            </label>\
          '; }).join('') + '\
        </div>\
        ' + (canRelease ? '\
          <div style="display: flex; justify-content: flex-end;">\
            <button class="btn btn-success" id="release-batch-btn" disabled>Sign & Release Batch</button>\
          </div>\
        ' : '') + '\
      ';
    }

    function renderAuditTab(batch) {
      return '\
        <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 600; margin-bottom: 20px;">Audit Trail</h3>\
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 20px;">Complete record for 21 CFR Part 11 compliance.</p>\
        <div style="display: flex; flex-direction: column; gap: 12px;">\
          ' + batch.auditLog.slice().reverse().map(function(entry) {
            var user = getUser(entry.userId);
            return '\
              <div style="display: flex; gap: 16px; padding: 16px; background: var(--bg-primary); border-radius: 8px;">\
                <div style="width: 8px; height: 8px; border-radius: 50%; background: ' + (entry.signature ? 'var(--success)' : 'var(--info)') + '; margin-top: 6px; flex-shrink: 0;"></div>\
                <div style="flex: 1;">\
                  <div style="color: var(--text-primary); font-weight: 500;">' + entry.action + '</div>\
                  <div style="color: var(--text-muted); font-size: 13px;">' + (user ? user.name : 'Unknown') + ' • ' + formatDateTime(entry.timestamp) + '</div>\
                  ' + (entry.signature ? '<div style="color: var(--success); font-size: 12px; margin-top: 4px;">✓ Electronic Signature Verified</div>' : '') + '\
                </div>\
              </div>\
            ';
          }).join('') + '\
        </div>\
      ';
    }

    function renderSignatureModal() {
      return '\
        <div id="signature-modal" class="modal-overlay hidden">\
          <div class="card modal-content" style="width: 480px; max-width: 100%; padding: 32px;">\
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">\
              <div style="width: 48px; height: 48px; background: var(--janus-green); border-radius: 12px; display: flex; align-items: center; justify-content: center;">\
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>\
              </div>\
              <div>\
                <h2 style="color: var(--text-primary); font-size: 18px; font-weight: 600;">Electronic Signature</h2>\
                <p style="color: var(--text-muted); font-size: 13px;">21 CFR Part 11 Compliant</p>\
              </div>\
            </div>\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 20px;">\
              <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Action</div>\
              <div id="sig-action" style="color: var(--text-primary); font-weight: 500;"></div>\
            </div>\
            <div class="form-group">\
              <label class="form-label">Signature Meaning *</label>\
              <select class="input" id="sig-meaning">\
                <option value="">Select meaning...</option>\
                ' + SIGNATURE_MEANINGS.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join('') + '\
              </select>\
            </div>\
            <div class="form-group">\
              <label class="form-label">Password *</label>\
              <input class="input" type="password" id="sig-password" placeholder="Enter password to sign">\
            </div>\
            <div id="sig-error" class="hidden" style="color: var(--error); font-size: 14px; margin-bottom: 16px; padding: 12px; background: var(--error-light); border-radius: 8px;"></div>\
            <div style="display: flex; gap: 12px;">\
              <button class="btn btn-secondary" style="flex: 1;" id="cancel-sig">Cancel</button>\
              <button class="btn btn-primary" style="flex: 1;" id="confirm-sig">Sign & Confirm</button>\
            </div>\
          </div>\
        </div>\
      ';
    }

    function renderProducts() {
      return '\
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">\
          <div>\
            <h1 style="color: var(--text-primary); font-size: 28px; font-weight: 700; margin-bottom: 4px;">Products</h1>\
            <p style="color: var(--text-muted);">Manage product specifications</p>\
          </div>\
          <button class="btn btn-primary" id="add-product-btn">+ New Product</button>\
        </div>\
        <div class="card" style="overflow: hidden;">\
          <table>\
            <thead><tr><th>FG #</th><th>Name</th><th>Customer</th><th>Incubation</th><th>Shelf Life</th></tr></thead>\
            <tbody>\
              ' + PRODUCTS.map(function(p) { return '\
                <tr>\
                  <td class="mono" style="font-weight: 600;">' + p.id + '</td>\
                  <td>' + p.name + '</td>\
                  <td style="color: var(--text-muted);">' + p.customer + '</td>\
                  <td>' + p.incubationDays + ' days</td>\
                  <td>' + p.shelfLife + ' months</td>\
                </tr>\
              '; }).join('') + '\
            </tbody>\
          </table>\
        </div>\
      ';
    }

    function renderProductWizard() {
      var step = state.productWizardStep;
      var p = state.newProduct;
      
      return '\
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">\
          <div>\
            <h1 style="color: var(--text-primary); font-size: 28px; font-weight: 700; margin-bottom: 4px;">New Product Setup</h1>\
            <p style="color: var(--text-muted);">Step ' + step + ' of 4</p>\
          </div>\
          <button class="btn btn-secondary" id="cancel-wizard">Cancel</button>\
        </div>\
        <div class="step-indicator">\
          <div class="step ' + (step > 1 ? 'complete' : (step === 1 ? 'active' : 'pending')) + '">1</div>\
          <div class="step-line ' + (step > 1 ? 'complete' : '') + '"></div>\
          <div class="step ' + (step > 2 ? 'complete' : (step === 2 ? 'active' : 'pending')) + '">2</div>\
          <div class="step-line ' + (step > 2 ? 'complete' : '') + '"></div>\
          <div class="step ' + (step > 3 ? 'complete' : (step === 3 ? 'active' : 'pending')) + '">3</div>\
          <div class="step-line ' + (step > 3 ? 'complete' : '') + '"></div>\
          <div class="step ' + (step === 4 ? 'active' : 'pending') + '">4</div>\
        </div>\
        <div class="card" style="padding: 32px;">\
          ' + (step === 1 ? renderProductStep1() : '') + '\
          ' + (step === 2 ? renderProductStep2() : '') + '\
          ' + (step === 3 ? renderProductStep3() : '') + '\
          ' + (step === 4 ? renderProductStep4() : '') + '\
        </div>\
      ';
    }

    function renderProductStep1() {
      var p = state.newProduct;
      return '\
        <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">Basic Information</h2>\
        <div class="grid-2" style="margin-bottom: 20px;">\
          <div class="form-group">\
            <label class="form-label">FG Number *</label>\
            <input class="input" type="text" id="pw-fg" placeholder="FG0015" value="' + (p.id || '') + '">\
          </div>\
          <div class="form-group">\
            <label class="form-label">Product Name *</label>\
            <input class="input" type="text" id="pw-name" placeholder="Classic Chicken Bone Broth" value="' + (p.name || '') + '">\
          </div>\
          <div class="form-group">\
            <label class="form-label">Customer *</label>\
            <input class="input" type="text" id="pw-customer" placeholder="Kettle & Fire" value="' + (p.customer || '') + '">\
          </div>\
          <div class="form-group">\
            <label class="form-label">Batch Size (lbs)</label>\
            <input class="input" type="text" id="pw-batchsize" placeholder="3900" value="' + (p.batchSize || '') + '">\
          </div>\
          <div class="form-group">\
            <label class="form-label">Incubation Days *</label>\
            <select class="input" id="pw-incubation">\
              <option value="10" ' + (p.incubationDays === 10 ? 'selected' : '') + '>10 days</option>\
              <option value="14" ' + (p.incubationDays === 14 ? 'selected' : '') + '>14 days</option>\
            </select>\
          </div>\
          <div class="form-group">\
            <label class="form-label">Shelf Life (months)</label>\
            <input class="input" type="text" id="pw-shelflife" placeholder="24" value="' + (p.shelfLife || '') + '">\
          </div>\
        </div>\
        <div style="display: flex; justify-content: flex-end; gap: 12px;">\
          <button class="btn btn-primary" id="wizard-next">Next →</button>\
        </div>\
      ';
    }

    function renderProductStep2() {
      var p = state.newProduct;
      var specs = p.specs || {};
      var notReq = specs.notRequired || {};
      return '\
        <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">Product Specifications</h2>\
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 20px;">Check "N/R" (Not Required) for specs that don\'t apply to this product.</p>\
        \
        <div style="display: grid; grid-template-columns: 1fr 1fr 50px; gap: 16px; align-items: end; margin-bottom: 16px;">\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">Fill Weight Min (g) *</label>\
            <input class="input" type="text" id="pw-fw-min" placeholder="Enter min" value="' + (specs.fillWeightMin || '') + '">\
          </div>\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">Fill Weight Max (g) *</label>\
            <input class="input" type="text" id="pw-fw-max" placeholder="Enter max" value="' + (specs.fillWeightMax || '') + '">\
          </div>\
          <div style="height: 42px;"></div>\
        </div>\
        \
        <div style="display: grid; grid-template-columns: 1fr 1fr 50px; gap: 16px; align-items: end; margin-bottom: 16px;">\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">pH Min *</label>\
            <input class="input" type="text" id="pw-ph-min" placeholder="Enter min" value="' + (specs.phMin || '') + '">\
          </div>\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">pH Max *</label>\
            <input class="input" type="text" id="pw-ph-max" placeholder="Enter max" value="' + (specs.phMax || '') + '">\
          </div>\
          <div style="height: 42px;"></div>\
        </div>\
        \
        <div style="display: grid; grid-template-columns: 1fr 1fr 50px; gap: 16px; align-items: end; margin-bottom: 16px;">\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">Brix Min</label>\
            <input class="input" type="text" id="pw-brix-min" placeholder="Enter min" value="' + (specs.brixMin || '') + '" ' + (notReq.brix ? 'disabled style="opacity: 0.5;"' : '') + '>\
          </div>\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">Brix Max</label>\
            <input class="input" type="text" id="pw-brix-max" placeholder="Enter max" value="' + (specs.brixMax || '') + '" ' + (notReq.brix ? 'disabled style="opacity: 0.5;"' : '') + '>\
          </div>\
          <div style="display: flex; align-items: center; justify-content: center; height: 42px;">\
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-muted);" title="Not Required">\
              <input type="checkbox" id="pw-nr-brix" ' + (notReq.brix ? 'checked' : '') + '> N/R\
            </label>\
          </div>\
        </div>\
        \
        <div style="display: grid; grid-template-columns: 1fr 1fr 50px; gap: 16px; align-items: end; margin-bottom: 16px;">\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">Salt % Min</label>\
            <input class="input" type="text" id="pw-salt-min" placeholder="Enter min" value="' + (specs.saltMin || '') + '" ' + (notReq.salt ? 'disabled style="opacity: 0.5;"' : '') + '>\
          </div>\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">Salt % Max</label>\
            <input class="input" type="text" id="pw-salt-max" placeholder="Enter max" value="' + (specs.saltMax || '') + '" ' + (notReq.salt ? 'disabled style="opacity: 0.5;"' : '') + '>\
          </div>\
          <div style="display: flex; align-items: center; justify-content: center; height: 42px;">\
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-muted);" title="Not Required">\
              <input type="checkbox" id="pw-nr-salt" ' + (notReq.salt ? 'checked' : '') + '> N/R\
            </label>\
          </div>\
        </div>\
        \
        <div style="display: grid; grid-template-columns: 1fr 1fr 50px; gap: 16px; align-items: end; margin-bottom: 16px;">\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">Bostwick Min</label>\
            <input class="input" type="text" id="pw-bostwick-min" placeholder="Enter min" value="' + (specs.bostwickMin || '') + '" ' + (notReq.bostwick ? 'disabled style="opacity: 0.5;"' : '') + '>\
          </div>\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">Bostwick Max</label>\
            <input class="input" type="text" id="pw-bostwick-max" placeholder="Enter max" value="' + (specs.bostwickMax || '') + '" ' + (notReq.bostwick ? 'disabled style="opacity: 0.5;"' : '') + '>\
          </div>\
          <div style="display: flex; align-items: center; justify-content: center; height: 42px;">\
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-muted);" title="Not Required">\
              <input type="checkbox" id="pw-nr-bostwick" ' + (notReq.bostwick ? 'checked' : '') + '> N/R\
            </label>\
          </div>\
        </div>\
        \
        <div style="display: grid; grid-template-columns: 1fr 1fr 50px; gap: 16px; align-items: end; margin-bottom: 24px;">\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">% Solids Min</label>\
            <input class="input" type="text" id="pw-solids-min" placeholder="Enter min" value="' + (specs.solidsMin || '') + '" ' + (notReq.solids ? 'disabled style="opacity: 0.5;"' : '') + '>\
          </div>\
          <div class="form-group" style="margin-bottom: 0;">\
            <label class="form-label">% Solids Max</label>\
            <input class="input" type="text" id="pw-solids-max" placeholder="Enter max" value="' + (specs.solidsMax || '') + '" ' + (notReq.solids ? 'disabled style="opacity: 0.5;"' : '') + '>\
          </div>\
          <div style="display: flex; align-items: center; justify-content: center; height: 42px;">\
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-muted);" title="Not Required">\
              <input type="checkbox" id="pw-nr-solids" ' + (notReq.solids ? 'checked' : '') + '> N/R\
            </label>\
          </div>\
        </div>\
        \
        <div style="display: flex; justify-content: space-between; gap: 12px;">\
          <button class="btn btn-secondary" id="wizard-back">← Back</button>\
          <button class="btn btn-primary" id="wizard-next">Next →</button>\
        </div>\
      ';
    }

    function renderProductStep3() {
      var p = state.newProduct;
      var samples = p.samples || {};
      return '\
        <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">Sample Requirements</h2>\
        <div class="grid-2" style="margin-bottom: 20px;">\
          <div class="form-group">\
            <label class="form-label">Post Retort Samples (per retort)</label>\
            <input class="input" type="text" id="pw-sample-pr" placeholder="2" value="' + (samples.postRetort || '') + '">\
          </div>\
          <div class="form-group">\
            <label class="form-label">Library Samples (per retort)</label>\
            <input class="input" type="text" id="pw-sample-lib" placeholder="3" value="' + (samples.lib || '') + '">\
          </div>\
          <div class="form-group">\
            <label class="form-label">Incubation Samples (per retort)</label>\
            <input class="input" type="text" id="pw-sample-inc" placeholder="1" value="' + (samples.incubation || '') + '">\
          </div>\
          <div class="form-group">\
            <label class="form-label">Customer Samples (per retort)</label>\
            <input class="input" type="text" id="pw-sample-cust" placeholder="3" value="' + (samples.customer || '') + '">\
          </div>\
        </div>\
        <h3 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px; margin-top: 24px;">Certifications</h3>\
        <div style="display: flex; gap: 16px; margin-bottom: 20px;">\
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">\
            <input type="checkbox" id="pw-cert-gf" ' + ((p.certifications || []).indexOf('Gluten Free') > -1 ? 'checked' : '') + '>\
            <span>Gluten Free</span>\
          </label>\
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">\
            <input type="checkbox" id="pw-cert-org" ' + ((p.certifications || []).indexOf('Organic') > -1 ? 'checked' : '') + '>\
            <span>Organic</span>\
          </label>\
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">\
            <input type="checkbox" id="pw-cert-kosher" ' + ((p.certifications || []).indexOf('Kosher') > -1 ? 'checked' : '') + '>\
            <span>Kosher</span>\
          </label>\
        </div>\
        <div style="display: flex; justify-content: space-between; gap: 12px;">\
          <button class="btn btn-secondary" id="wizard-back">← Back</button>\
          <button class="btn btn-primary" id="wizard-next">Next →</button>\
        </div>\
      ';
    }

    function renderProductStep4() {
      var p = state.newProduct;
      var specs = p.specs || {};
      var samples = p.samples || {};
      var notReq = specs.notRequired || {};
      
      function specVal(field, min, max, suffix) {
        if (notReq[field]) return '<span style="color: var(--text-muted); font-style: italic;">N/R</span>';
        if (!min && !max) return '—';
        return '<strong>' + (min || '—') + '-' + (max || '—') + (suffix || '') + '</strong>';
      }
      
      return '\
        <h2 style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 24px;">Review & Submit</h2>\
        <div style="padding: 20px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 24px;">\
          <h3 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">Basic Information</h3>\
          <div class="grid-3" style="gap: 12px; font-size: 14px;">\
            <div><span style="color: var(--text-muted);">FG#:</span> <strong>' + (p.id || '—') + '</strong></div>\
            <div><span style="color: var(--text-muted);">Name:</span> <strong>' + (p.name || '—') + '</strong></div>\
            <div><span style="color: var(--text-muted);">Customer:</span> <strong>' + (p.customer || '—') + '</strong></div>\
            <div><span style="color: var(--text-muted);">Batch Size:</span> <strong>' + (p.batchSize || '—') + ' lbs</strong></div>\
            <div><span style="color: var(--text-muted);">Incubation:</span> <strong>' + (p.incubationDays || '—') + ' days</strong></div>\
            <div><span style="color: var(--text-muted);">Shelf Life:</span> <strong>' + (p.shelfLife || '—') + ' months</strong></div>\
          </div>\
        </div>\
        <div style="padding: 20px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 24px;">\
          <h3 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">Specifications</h3>\
          <div class="grid-3" style="gap: 12px; font-size: 14px;">\
            <div><span style="color: var(--text-muted);">Fill Weight:</span> <strong>' + (specs.fillWeightMin || '—') + '-' + (specs.fillWeightMax || '—') + 'g</strong></div>\
            <div><span style="color: var(--text-muted);">pH:</span> <strong>' + (specs.phMin || '—') + '-' + (specs.phMax || '—') + '</strong></div>\
            <div><span style="color: var(--text-muted);">Brix:</span> ' + specVal('brix', specs.brixMin, specs.brixMax, '') + '</div>\
            <div><span style="color: var(--text-muted);">Salt %:</span> ' + specVal('salt', specs.saltMin, specs.saltMax, '%') + '</div>\
            <div><span style="color: var(--text-muted);">Bostwick:</span> ' + specVal('bostwick', specs.bostwickMin, specs.bostwickMax, '') + '</div>\
            <div><span style="color: var(--text-muted);">% Solids:</span> ' + specVal('solids', specs.solidsMin, specs.solidsMax, '%') + '</div>\
          </div>\
        </div>\
        <div style="display: flex; justify-content: space-between; gap: 12px;">\
          <button class="btn btn-secondary" id="wizard-back">← Back</button>\
          <button class="btn btn-success" id="wizard-submit">Create Product</button>\
        </div>\
      ';
    }

    // ============================================================================
    // EVENT HANDLERS
    // ============================================================================

    var pendingSignatureCallback = null;

    function attachEventListeners() {
      // Login
      var loginBtn = document.getElementById('login-btn');
      if (loginBtn) loginBtn.addEventListener('click', handleLogin);
      
      var loginPass = document.getElementById('login-password');
      if (loginPass) loginPass.addEventListener('keypress', function(e) { if (e.key === 'Enter') handleLogin(); });
      
      document.querySelectorAll('.quick-login-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var userId = btn.dataset.userid;
          var user = USERS.find(function(u) { return u.id === userId; });
          if (user) {
            state.currentUser = user;
            state.view = 'dashboard';
            render();
          }
        });
      });
      
      // Logout
      var logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) logoutBtn.addEventListener('click', function() {
        state.currentUser = null;
        state.view = 'login';
        render();
      });
      
      // Navigation
      document.querySelectorAll('.nav-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          state.view = btn.dataset.view;
          state.selectedBatch = null;
          render();
        });
      });
      
      // Stat cards filter
      document.querySelectorAll('.stat-card[data-filter]').forEach(function(card) {
        card.addEventListener('click', function() {
          state.view = 'batches';
          render();
        });
      });
      
      // View all buttons
      document.querySelectorAll('[data-filter]').forEach(function(el) {
        if (el.classList.contains('btn')) {
          el.addEventListener('click', function() {
            state.view = 'batches';
            render();
          });
        }
      });
      
      // Batch cards and rows
      document.querySelectorAll('.batch-card, .batch-row').forEach(function(el) {
        el.addEventListener('click', function() {
          var batchId = el.dataset.batchid;
          state.selectedBatch = state.batches.find(function(b) { return b.id === batchId; });
          state.view = 'batch-detail';
          state.activeTab = 'inprocess';
          render();
        });
      });
      
      // Back button
      var backBtn = document.querySelector('.back-btn');
      if (backBtn) backBtn.addEventListener('click', function() {
        state.view = 'batches';
        state.selectedBatch = null;
        render();
      });
      
      // Cancel batch handlers
      var cancelBatchBtn = document.getElementById('cancel-batch-btn');
      if (cancelBatchBtn) cancelBatchBtn.addEventListener('click', function() {
        document.getElementById('cancel-batch-modal').classList.remove('hidden');
      });
      
      var cancelBatchCancel = document.getElementById('cancel-batch-cancel');
      if (cancelBatchCancel) cancelBatchCancel.addEventListener('click', function() {
        document.getElementById('cancel-batch-modal').classList.add('hidden');
        document.getElementById('cancel-reason').value = '';
        document.getElementById('cancel-supervisor').value = '';
        document.getElementById('cancel-supervisor-password').value = '';
      });
      
      var cancelBatchConfirm = document.getElementById('cancel-batch-confirm');
      if (cancelBatchConfirm) cancelBatchConfirm.addEventListener('click', function() {
        var reason = document.getElementById('cancel-reason').value.trim();
        var supervisorId = document.getElementById('cancel-supervisor').value;
        var password = document.getElementById('cancel-supervisor-password').value;
        
        if (!reason) {
          showNotification('Please enter a reason for cancellation', 'error');
          return;
        }
        if (!supervisorId) {
          showNotification('Please select an approving supervisor', 'error');
          return;
        }
        
        var supervisor = USERS.find(function(u) { return u.id === supervisorId; });
        if (!supervisor || !supervisor.canRelease) {
          showNotification('Invalid supervisor selected', 'error');
          return;
        }
        if (password !== supervisor.password) {
          showNotification('Incorrect supervisor password', 'error');
          return;
        }
        
        // Cancel the batch
        var batch = state.selectedBatch;
        batch.status = 'cancelled';
        batch.cancelledAt = new Date().toISOString();
        batch.cancelledBy = state.currentUser.id;
        batch.cancellationReason = reason;
        batch.cancellationApprovedBy = supervisorId;
        batch.auditLog.push({ 
          action: 'Batch Cancellation Requested', 
          userId: state.currentUser.id, 
          timestamp: new Date().toISOString(),
          details: 'Reason: ' + reason
        });
        batch.auditLog.push({ 
          action: 'Batch Cancellation Approved by Supervisor: ' + supervisor.name, 
          userId: supervisorId, 
          timestamp: new Date().toISOString(),
          signature: true 
        });
        
        document.getElementById('cancel-batch-modal').classList.add('hidden');
        showNotification('Batch ' + batch.id + ' has been cancelled', 'warning');
        render();
      });
      
      // Detail tabs
      document.querySelectorAll('.detail-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
          state.activeTab = tab.dataset.tab;
          render();
        });
      });
      
      // New batch modal
      var newBatchBtn = document.getElementById('new-batch-btn');
      if (newBatchBtn) newBatchBtn.addEventListener('click', function() {
        document.getElementById('new-batch-modal').classList.remove('hidden');
      });
      
      var cancelNewBatch = document.getElementById('cancel-new-batch');
      if (cancelNewBatch) cancelNewBatch.addEventListener('click', function() {
        document.getElementById('new-batch-modal').classList.add('hidden');
      });
      
      var newBatchProduct = document.getElementById('new-batch-product');
      if (newBatchProduct) newBatchProduct.addEventListener('change', function(e) {
        var productId = e.target.value;
        var preview = document.getElementById('product-preview');
        var createBtn = document.getElementById('create-batch-btn');
        if (productId) {
          var product = getProduct(productId);
          preview.innerHTML = '\
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 24px;">\
              <div class="grid-2" style="gap: 12px; font-size: 13px;">\
                <div><span style="color: var(--text-muted);">Customer:</span> <span style="font-weight: 500;">' + product.customer + '</span></div>\
                <div><span style="color: var(--text-muted);">Batch Size:</span> <span style="font-weight: 500;">' + product.batchSize + ' lbs</span></div>\
                <div><span style="color: var(--text-muted);">Incubation:</span> <span style="font-weight: 500;">' + product.incubationDays + ' days</span></div>\
                <div><span style="color: var(--text-muted);">Shelf Life:</span> <span style="font-weight: 500;">' + product.shelfLife + ' months</span></div>\
              </div>\
            </div>\
          ';
          createBtn.disabled = false;
        } else {
          preview.innerHTML = '';
          createBtn.disabled = true;
        }
      });
      
      var createBatchBtn = document.getElementById('create-batch-btn');
      if (createBatchBtn) createBatchBtn.addEventListener('click', function() {
        var productId = document.getElementById('new-batch-product').value;
        if (productId) {
          var newBatch = {
            id: 'B2026-' + String(state.batches.length + 1).padStart(4, '0'),
            productId: productId,
            status: 'in_progress',
            createdAt: new Date().toISOString(),
            createdBy: state.currentUser.id,
            inProcess: null,
            filling: { sealChecks: [], codeChecks: [], xrayChecks: [] },
            postRetort: { tests: [] },
            retorts: [], samples: [], incubation: null,
            auditLog: [{ action: 'Batch Created', userId: state.currentUser.id, timestamp: new Date().toISOString() }]
          };
          state.batches.push(newBatch);
          state.selectedBatch = newBatch;
          state.view = 'batch-detail';
          state.activeTab = 'inprocess';
          document.getElementById('new-batch-modal').classList.add('hidden');
          showNotification('Batch ' + newBatch.id + ' created', 'success');
          render();
        }
      });
      
      // In-process submit with OOS validation
      var submitInprocess = document.getElementById('submit-inprocess');
      if (submitInprocess) submitInprocess.addEventListener('click', function() {
        var batch = state.selectedBatch;
        var product = PRODUCTS.find(function(p) { return p.id === batch.productId; });
        var errorEl = document.getElementById('ip-validation-error');
        
        // Collect form values
        var formData = {
          ph: document.getElementById('ip-ph').value.trim(),
          brix: document.getElementById('ip-brix').value.trim(),
          salt: document.getElementById('ip-salt').value.trim(),
          temp: document.getElementById('ip-temp').value.trim(),
          weight: document.getElementById('ip-weight').value.trim(),
          organoleptic: document.getElementById('ip-organo').value,
          taste: document.getElementById('ip-taste').value,
          release: document.getElementById('ip-release').value
        };
        
        // Validate all fields required
        var missing = [];
        if (!formData.weight) missing.push('Batch Weight');
        if (!formData.temp) missing.push('Temperature');
        if (!formData.ph) missing.push('pH');
        if (!formData.brix) missing.push('Brix');
        if (!formData.salt) missing.push('Salt %');
        if (!formData.organoleptic) missing.push('Organoleptic');
        if (!formData.taste) missing.push('Taste');
        if (!formData.release) missing.push('Release to Fill');
        
        if (missing.length > 0) {
          errorEl.textContent = 'Required fields: ' + missing.join(', ');
          errorEl.classList.remove('hidden');
          return;
        }
        errorEl.classList.add('hidden');
        
        // Check for OOS
        var oosItems = getOOSItems(formData, product);
        var hasOOS = oosItems.length > 0;
        var releaseYes = formData.release === 'yes';
        
        // Store pending data for modals
        window.pendingInProcessData = formData;
        window.pendingInProcessOOS = oosItems;
        
        if (hasOOS && !releaseYes) {
          // Scenario: OOS detected, release = no - confirm OOS is the reason
          var oosHtml = oosItems.map(function(item) {
            return '<div style="margin-bottom: 8px;"><strong>' + item.field + ':</strong> ' + item.value + ' <span style="color: var(--error);">(Spec: ' + item.spec + ')</span></div>';
          }).join('');
          document.getElementById('oos-fields-list').innerHTML = oosHtml;
          document.getElementById('oos-no-release-modal').classList.remove('hidden');
        } else if (!hasOOS && !releaseYes) {
          // Scenario: All in spec, release = no - require reason
          document.getElementById('no-release-reason-modal').classList.remove('hidden');
        } else if (hasOOS && releaseYes) {
          // Scenario: OOS detected, release = yes - supervisor approval required
          var oosHtml = oosItems.map(function(item) {
            return '<div style="margin-bottom: 8px;"><strong>' + item.field + ':</strong> ' + item.value + ' <span style="color: var(--error);">(Spec: ' + item.spec + ')</span></div>';
          }).join('');
          document.getElementById('oos-release-fields-list').innerHTML = oosHtml;
          document.getElementById('oos-yes-release-modal').classList.remove('hidden');
        } else {
          // Scenario: All in spec, release = yes - proceed to signature
          proceedToInProcessSignature(formData, null, null);
        }
      });
      
      // OOS No Release - Confirm modal
      var cancelOosNo = document.getElementById('cancel-oos-no');
      if (cancelOosNo) cancelOosNo.addEventListener('click', function() {
        document.getElementById('oos-no-release-modal').classList.add('hidden');
      });
      
      var confirmOosNo = document.getElementById('confirm-oos-no');
      if (confirmOosNo) confirmOosNo.addEventListener('click', function() {
        document.getElementById('oos-no-release-modal').classList.add('hidden');
        var oosReason = 'OOS: ' + window.pendingInProcessOOS.map(function(i) { return i.field; }).join(', ');
        proceedToInProcessSignature(window.pendingInProcessData, oosReason, null);
      });
      
      // No Release Reason modal
      var cancelNoRelease = document.getElementById('cancel-no-release');
      if (cancelNoRelease) cancelNoRelease.addEventListener('click', function() {
        document.getElementById('no-release-reason-modal').classList.add('hidden');
        document.getElementById('no-release-reason').value = '';
      });
      
      var confirmNoRelease = document.getElementById('confirm-no-release');
      if (confirmNoRelease) confirmNoRelease.addEventListener('click', function() {
        var reason = document.getElementById('no-release-reason').value.trim();
        if (!reason) {
          showNotification('Please enter a reason', 'error');
          return;
        }
        document.getElementById('no-release-reason-modal').classList.add('hidden');
        document.getElementById('no-release-reason').value = '';
        proceedToInProcessSignature(window.pendingInProcessData, reason, null);
      });
      
      // OOS Yes Release - Warning modal
      var cancelOosYes = document.getElementById('cancel-oos-yes');
      if (cancelOosYes) cancelOosYes.addEventListener('click', function() {
        document.getElementById('oos-yes-release-modal').classList.add('hidden');
      });
      
      var confirmOosYes = document.getElementById('confirm-oos-yes');
      if (confirmOosYes) confirmOosYes.addEventListener('click', function() {
        document.getElementById('oos-yes-release-modal').classList.add('hidden');
        // Show supervisor approval modal
        document.getElementById('supervisor-oos-summary').textContent = window.pendingInProcessOOS.map(function(i) { return i.field + ': ' + i.value; }).join(', ');
        document.getElementById('supervisor-approval-modal').classList.remove('hidden');
      });
      
      // Supervisor Approval modal
      var cancelSupervisor = document.getElementById('cancel-supervisor');
      if (cancelSupervisor) cancelSupervisor.addEventListener('click', function() {
        document.getElementById('supervisor-approval-modal').classList.add('hidden');
        document.getElementById('supervisor-select').value = '';
        document.getElementById('supervisor-password').value = '';
        document.getElementById('supervisor-error').classList.add('hidden');
      });
      
      var confirmSupervisor = document.getElementById('confirm-supervisor');
      if (confirmSupervisor) confirmSupervisor.addEventListener('click', function() {
        var supervisorId = document.getElementById('supervisor-select').value;
        var password = document.getElementById('supervisor-password').value;
        var errorEl = document.getElementById('supervisor-error');
        
        if (!supervisorId) {
          errorEl.textContent = 'Please select a supervisor';
          errorEl.classList.remove('hidden');
          return;
        }
        
        var supervisor = USERS.find(function(u) { return u.id === supervisorId; });
        if (!supervisor || !supervisor.canRelease) {
          errorEl.textContent = 'Selected user is not authorized to approve';
          errorEl.classList.remove('hidden');
          return;
        }
        
        if (password !== 'demo') {
          errorEl.textContent = 'Invalid supervisor password (hint: demo)';
          errorEl.classList.remove('hidden');
          return;
        }
        
        document.getElementById('supervisor-approval-modal').classList.add('hidden');
        document.getElementById('supervisor-select').value = '';
        document.getElementById('supervisor-password').value = '';
        errorEl.classList.add('hidden');
        
        var oosApproval = {
          supervisorId: supervisorId,
          timestamp: new Date().toISOString(),
          oosFields: window.pendingInProcessOOS.map(function(i) { return i.field; })
        };
        proceedToInProcessSignature(window.pendingInProcessData, null, oosApproval);
      });
      
      function proceedToInProcessSignature(formData, noReleaseReason, oosApproval) {
        pendingSignatureCallback = function(sig) {
          var batch = state.selectedBatch;
          batch.inProcess = {
            ph: formData.ph,
            brix: formData.brix,
            salt: formData.salt,
            temp: formData.temp,
            weight: formData.weight,
            organoleptic: formData.organoleptic,
            taste: formData.taste,
            release: formData.release === 'yes',
            testedBy: state.currentUser.id,
            testedAt: new Date().toISOString()
          };
          
          if (noReleaseReason) {
            batch.inProcess.noReleaseReason = noReleaseReason;
          }
          
          if (oosApproval) {
            batch.inProcess.oosApproval = oosApproval;
            batch.inProcess.oosFields = oosApproval.oosFields;
            batch.auditLog.push({ 
              action: 'OOS Release Approved by Supervisor: ' + (getUser(oosApproval.supervisorId) ? getUser(oosApproval.supervisorId).name : 'Unknown'), 
              userId: oosApproval.supervisorId, 
              timestamp: oosApproval.timestamp, 
              signature: true 
            });
          }
          
          batch.auditLog.push({ 
            action: 'In-Process Testing Completed' + (batch.inProcess.release ? ' - Released to Fill' : ' - Not Released'), 
            userId: state.currentUser.id, 
            timestamp: new Date().toISOString(), 
            signature: true 
          });
          
          if (batch.inProcess.release) {
            batch.status = 'filling';
          }
          
          showNotification('In-Process testing saved' + (batch.inProcess.release ? ' - Released to TPR2' : ''), 'success');
          render();
        };
        document.getElementById('sig-action').textContent = 'Submit In-Process Testing Results';
        document.getElementById('signature-modal').classList.remove('hidden');
      }
      
      // Incubation submit
      var submitIncubation = document.getElementById('submit-incubation');
      if (submitIncubation) submitIncubation.addEventListener('click', function() {
        pendingSignatureCallback = function(sig) {
          var batch = state.selectedBatch;
          batch.incubation = {
            ph: document.getElementById('inc-ph').value,
            brix: document.getElementById('inc-brix').value,
            salt: document.getElementById('inc-salt').value,
            containerIntegrity: document.getElementById('inc-integrity').value,
            swelling: document.getElementById('inc-swelling').value,
            visualDefects: document.getElementById('inc-defects').value,
            testedBy: state.currentUser.id,
            testedAt: new Date().toISOString()
          };
          batch.status = 'pending_review';
          batch.auditLog.push({ action: 'Incubation Testing Completed', userId: state.currentUser.id, timestamp: new Date().toISOString(), signature: true });
          showNotification('Incubation testing completed - submitted for review', 'success');
          render();
        };
        document.getElementById('sig-action').textContent = 'Submit Incubation Testing & Send for Review';
        document.getElementById('signature-modal').classList.remove('hidden');
      });
      
      // Release checklist
      document.querySelectorAll('.release-check').forEach(function(check) {
        check.addEventListener('change', function() {
          var allChecked = Array.from(document.querySelectorAll('.release-check')).every(function(c) { return c.checked; });
          var btn = document.getElementById('release-batch-btn');
          if (btn) btn.disabled = !allChecked;
        });
      });
      
      // Release batch
      var releaseBatchBtn = document.getElementById('release-batch-btn');
      if (releaseBatchBtn) releaseBatchBtn.addEventListener('click', function() {
        pendingSignatureCallback = function(sig) {
          var batch = state.selectedBatch;
          batch.status = 'ready_to_ship';
          batch.release = {
            releasedBy: state.currentUser.id,
            releasedAt: new Date().toISOString()
          };
          batch.auditLog.push({ action: 'Batch Released - Ready to Ship', userId: state.currentUser.id, timestamp: new Date().toISOString(), signature: true });
          showNotification('Batch ' + batch.id + ' released - Ready to Ship', 'success');
          render();
        };
        document.getElementById('sig-action').textContent = 'Release Batch - Ready to Ship';
        document.getElementById('signature-modal').classList.remove('hidden');
      });
      
      // Signature modal
      var cancelSig = document.getElementById('cancel-sig');
      if (cancelSig) cancelSig.addEventListener('click', function() {
        document.getElementById('signature-modal').classList.add('hidden');
        pendingSignatureCallback = null;
      });
      
      var confirmSig = document.getElementById('confirm-sig');
      if (confirmSig) confirmSig.addEventListener('click', function() {
        var password = document.getElementById('sig-password').value;
        var meaning = document.getElementById('sig-meaning').value;
        var errorEl = document.getElementById('sig-error');
        
        if (password !== 'demo') {
          errorEl.textContent = 'Invalid password (hint: demo)';
          errorEl.classList.remove('hidden');
          return;
        }
        if (!meaning) {
          errorEl.textContent = 'Please select signature meaning';
          errorEl.classList.remove('hidden');
          return;
        }
        
        document.getElementById('signature-modal').classList.add('hidden');
        document.getElementById('sig-password').value = '';
        document.getElementById('sig-meaning').value = '';
        errorEl.classList.add('hidden');
        
        if (pendingSignatureCallback) {
          pendingSignatureCallback({ userId: state.currentUser.id, meaning: meaning, timestamp: new Date().toISOString() });
          pendingSignatureCallback = null;
        }
      });
      
      // Filling check modals
      var addSealCheck = document.getElementById('add-seal-check');
      if (addSealCheck) addSealCheck.addEventListener('click', function() {
        document.getElementById('seal-check-modal').classList.remove('hidden');
        var now = new Date();
        document.getElementById('seal-time').value = now.toTimeString().slice(0,5);
      });
      
      var cancelSealCheck = document.getElementById('cancel-seal-check');
      if (cancelSealCheck) cancelSealCheck.addEventListener('click', function() {
        document.getElementById('seal-check-modal').classList.add('hidden');
      });
      
      var saveSealCheck = document.getElementById('save-seal-check');
      if (saveSealCheck) saveSealCheck.addEventListener('click', function() {
        var batch = state.selectedBatch;
        var check = {
          time: document.getElementById('seal-time').value,
          carton1: {
            weight: document.getElementById('seal-c1-weight').value,
            integrity: document.getElementById('seal-c1-integrity').value,
            topSeal: document.getElementById('seal-c1-top').value,
            bottomSeal: document.getElementById('seal-c1-bottom').value
          },
          carton2: {
            weight: document.getElementById('seal-c2-weight').value,
            integrity: document.getElementById('seal-c2-integrity').value,
            topSeal: document.getElementById('seal-c2-top').value,
            bottomSeal: document.getElementById('seal-c2-bottom').value
          },
          checkedBy: state.currentUser.id,
          checkedAt: new Date().toISOString()
        };
        batch.filling.sealChecks.push(check);
        batch.auditLog.push({ action: 'Seal Check Recorded @ ' + check.time, userId: state.currentUser.id, timestamp: new Date().toISOString() });
        document.getElementById('seal-check-modal').classList.add('hidden');
        showNotification('Seal check saved', 'success');
        render();
      });
      
      var addCodeCheck = document.getElementById('add-code-check');
      if (addCodeCheck) addCodeCheck.addEventListener('click', function() {
        document.getElementById('code-check-modal').classList.remove('hidden');
        var now = new Date();
        document.getElementById('code-time').value = now.toTimeString().slice(0,5);
      });
      
      var cancelCodeCheck = document.getElementById('cancel-code-check');
      if (cancelCodeCheck) cancelCodeCheck.addEventListener('click', function() {
        document.getElementById('code-check-modal').classList.add('hidden');
      });
      
      var saveCodeCheck = document.getElementById('save-code-check');
      if (saveCodeCheck) saveCodeCheck.addEventListener('click', function() {
        var batch = state.selectedBatch;
        var check = {
          time: document.getElementById('code-time').value,
          code: document.getElementById('code-value').value,
          legible: document.getElementById('code-legible').value,
          checkedBy: state.currentUser.id,
          checkedAt: new Date().toISOString()
        };
        batch.filling.codeChecks.push(check);
        batch.auditLog.push({ action: 'Code Audit Recorded @ ' + check.time, userId: state.currentUser.id, timestamp: new Date().toISOString() });
        document.getElementById('code-check-modal').classList.add('hidden');
        showNotification('Code audit saved', 'success');
        render();
      });
      
      var addXrayCheck = document.getElementById('add-xray-check');
      if (addXrayCheck) addXrayCheck.addEventListener('click', function() {
        document.getElementById('xray-check-modal').classList.remove('hidden');
        var now = new Date();
        document.getElementById('xray-time').value = now.toTimeString().slice(0,5);
      });
      
      var cancelXrayCheck = document.getElementById('cancel-xray-check');
      if (cancelXrayCheck) cancelXrayCheck.addEventListener('click', function() {
        document.getElementById('xray-check-modal').classList.add('hidden');
      });
      
      var saveXrayCheck = document.getElementById('save-xray-check');
      if (saveXrayCheck) saveXrayCheck.addEventListener('click', function() {
        var batch = state.selectedBatch;
        var check = {
          time: document.getElementById('xray-time').value,
          ss: document.getElementById('xray-ss').value,
          fe: document.getElementById('xray-fe').value,
          nfe: document.getElementById('xray-nfe').value,
          checkedBy: state.currentUser.id,
          checkedAt: new Date().toISOString()
        };
        batch.filling.xrayChecks.push(check);
        batch.auditLog.push({ action: 'X-Ray Verification Recorded @ ' + check.time, userId: state.currentUser.id, timestamp: new Date().toISOString() });
        document.getElementById('xray-check-modal').classList.add('hidden');
        showNotification('X-Ray verification saved', 'success');
        render();
      });
      
      // Post-Retort Test handlers
      var addPostRetortTest = document.getElementById('add-postretort-test');
      if (addPostRetortTest) addPostRetortTest.addEventListener('click', function() {
        document.getElementById('postretort-test-modal').classList.remove('hidden');
        var now = new Date();
        document.getElementById('pr-carton-time').value = now.toTimeString().slice(0,5);
      });
      
      var cancelPostRetortTest = document.getElementById('cancel-postretort-test');
      if (cancelPostRetortTest) cancelPostRetortTest.addEventListener('click', function() {
        document.getElementById('postretort-test-modal').classList.add('hidden');
      });
      
      var savePostRetortTest = document.getElementById('save-postretort-test');
      if (savePostRetortTest) savePostRetortTest.addEventListener('click', function() {
        var batch = state.selectedBatch;
        var test = {
          retortNum: document.getElementById('pr-retort-num').value.trim(),
          loadNum: document.getElementById('pr-load-num').value.trim(),
          cartonTime: document.getElementById('pr-carton-time').value,
          cartonNum: document.getElementById('pr-carton-num').value.trim(),
          flapsSecure: document.getElementById('pr-flaps').value,
          sealIntegrity: document.getElementById('pr-integrity').value,
          conductivity: document.getElementById('pr-conductivity').value,
          redInkTest: document.getElementById('pr-redink').value,
          topSeal: document.getElementById('pr-top-seal').value.trim(),
          bottomSeal: document.getElementById('pr-bottom-seal').value.trim(),
          testedBy: state.currentUser.id,
          testedAt: new Date().toISOString()
        };
        
        // Validate required fields
        if (!test.retortNum || !test.loadNum || !test.cartonNum || !test.flapsSecure || 
            !test.sealIntegrity || !test.conductivity || !test.redInkTest || 
            !test.topSeal || !test.bottomSeal) {
          showNotification('Please fill all required fields', 'error');
          return;
        }
        
        if (!batch.postRetort) batch.postRetort = { tests: [] };
        batch.postRetort.tests.push(test);
        batch.auditLog.push({ action: 'Post-Retort Test Recorded: Retort #' + test.retortNum + ' Load #' + test.loadNum, userId: state.currentUser.id, timestamp: new Date().toISOString() });
        document.getElementById('postretort-test-modal').classList.add('hidden');
        showNotification('Post-retort test saved', 'success');
        render();
      });
      
      var completePostRetort = document.getElementById('complete-postretort');
      if (completePostRetort) completePostRetort.addEventListener('click', function() {
        var batch = state.selectedBatch;
        var product = PRODUCTS.find(function(p) { return p.id === batch.productId; });
        
        // Mark post-retort complete and move to incubation
        batch.postRetort.complete = true;
        batch.postRetort.completedBy = state.currentUser.id;
        batch.postRetort.completedAt = new Date().toISOString();
        batch.status = 'incubation';
        batch.incubationStartDate = new Date().toISOString();
        batch.auditLog.push({ action: 'Post-Retort Testing Completed', userId: state.currentUser.id, timestamp: new Date().toISOString(), signature: true });
        batch.auditLog.push({ action: 'Moved to Incubation Hold (' + product.incubationDays + ' days)', userId: state.currentUser.id, timestamp: new Date().toISOString() });
        
        showNotification('Batch moved to incubation hold', 'success');
        state.activeTab = 'incubation';
        render();
      });
      
      // New Product buttons
      var newProductBtn = document.getElementById('new-product-btn');
      if (newProductBtn) newProductBtn.addEventListener('click', function() {
        state.view = 'new-product';
        state.productWizardStep = 1;
        state.newProduct = {};
        render();
      });
      
      var addProductBtn = document.getElementById('add-product-btn');
      if (addProductBtn) addProductBtn.addEventListener('click', function() {
        state.view = 'new-product';
        state.productWizardStep = 1;
        state.newProduct = {};
        render();
      });
      
      var cancelWizard = document.getElementById('cancel-wizard');
      if (cancelWizard) cancelWizard.addEventListener('click', function() {
        state.view = 'products';
        state.productWizardStep = 1;
        state.newProduct = {};
        render();
      });
      
      // Wizard navigation
      var wizardNext = document.getElementById('wizard-next');
      if (wizardNext) wizardNext.addEventListener('click', function() {
        saveWizardStep();
        state.productWizardStep++;
        render();
      });
      
      var wizardBack = document.getElementById('wizard-back');
      if (wizardBack) wizardBack.addEventListener('click', function() {
        saveWizardStep();
        state.productWizardStep--;
        render();
      });
      
      var wizardSubmit = document.getElementById('wizard-submit');
      if (wizardSubmit) wizardSubmit.addEventListener('click', function() {
        var p = state.newProduct;
        var notReq = (p.specs && p.specs.notRequired) || {};
        var newProduct = {
          id: p.id,
          name: p.name,
          customer: p.customer,
          batchSize: parseInt(p.batchSize) || 3900,
          incubationDays: parseInt(p.incubationDays) || 10,
          shelfLife: parseInt(p.shelfLife) || 24,
          specs: {
            fillWeight: { min: parseFloat(p.specs.fillWeightMin) || 465, max: parseFloat(p.specs.fillWeightMax) || 495, unit: 'g' },
            ph: { min: parseFloat(p.specs.phMin) || 5.6, max: parseFloat(p.specs.phMax) || 6.5 },
            brix: notReq.brix ? null : { min: parseFloat(p.specs.brixMin) || 5.0, max: parseFloat(p.specs.brixMax) || 6.0 },
            salt: notReq.salt ? null : { min: parseFloat(p.specs.saltMin) || 0.3, max: parseFloat(p.specs.saltMax) || 0.4 },
            bostwick: notReq.bostwick ? null : (p.specs.bostwickMin && p.specs.bostwickMax ? { min: parseFloat(p.specs.bostwickMin), max: parseFloat(p.specs.bostwickMax) } : null),
            solids: notReq.solids ? null : (p.specs.solidsMin && p.specs.solidsMax ? { min: parseFloat(p.specs.solidsMin), max: parseFloat(p.specs.solidsMax) } : null)
          },
          tests: ['ph', 'brix', 'salt'],
          samples: p.samples || { postRetort: 2, lib: 3, incubation: 1, customer: 3 },
          certifications: p.certifications || []
        };
        PRODUCTS.push(newProduct);
        state.view = 'products';
        state.productWizardStep = 1;
        state.newProduct = {};
        showNotification('Product ' + newProduct.id + ' created', 'success');
        render();
      });
      
      // N/R checkbox handlers (disable/enable inputs when checked)
      ['brix', 'salt', 'bostwick', 'solids'].forEach(function(field) {
        var checkbox = document.getElementById('pw-nr-' + field);
        if (checkbox) {
          checkbox.addEventListener('change', function() {
            var minInput = document.getElementById('pw-' + field + '-min');
            var maxInput = document.getElementById('pw-' + field + '-max');
            if (minInput) {
              minInput.disabled = this.checked;
              minInput.style.opacity = this.checked ? '0.5' : '1';
              if (this.checked) minInput.value = '';
            }
            if (maxInput) {
              maxInput.disabled = this.checked;
              maxInput.style.opacity = this.checked ? '0.5' : '1';
              if (this.checked) maxInput.value = '';
            }
          });
        }
      });
    }

    function saveWizardStep() {
      var step = state.productWizardStep;
      var p = state.newProduct;
      
      if (step === 1) {
        var fgEl = document.getElementById('pw-fg');
        var nameEl = document.getElementById('pw-name');
        var custEl = document.getElementById('pw-customer');
        var batchEl = document.getElementById('pw-batchsize');
        var incEl = document.getElementById('pw-incubation');
        var shelfEl = document.getElementById('pw-shelflife');
        
        p.id = fgEl ? fgEl.value : '';
        p.name = nameEl ? nameEl.value : '';
        p.customer = custEl ? custEl.value : '';
        p.batchSize = batchEl ? batchEl.value : '';
        p.incubationDays = incEl ? parseInt(incEl.value) : 10;
        p.shelfLife = shelfEl ? shelfEl.value : '';
      } else if (step === 2) {
        p.specs = p.specs || {};
        p.specs.notRequired = p.specs.notRequired || {};
        var fwMinEl = document.getElementById('pw-fw-min');
        var fwMaxEl = document.getElementById('pw-fw-max');
        var phMinEl = document.getElementById('pw-ph-min');
        var phMaxEl = document.getElementById('pw-ph-max');
        var brixMinEl = document.getElementById('pw-brix-min');
        var brixMaxEl = document.getElementById('pw-brix-max');
        var saltMinEl = document.getElementById('pw-salt-min');
        var saltMaxEl = document.getElementById('pw-salt-max');
        var bostwickMinEl = document.getElementById('pw-bostwick-min');
        var bostwickMaxEl = document.getElementById('pw-bostwick-max');
        var solidsMinEl = document.getElementById('pw-solids-min');
        var solidsMaxEl = document.getElementById('pw-solids-max');
        
        // N/R checkboxes
        var nrBrixEl = document.getElementById('pw-nr-brix');
        var nrSaltEl = document.getElementById('pw-nr-salt');
        var nrBostwickEl = document.getElementById('pw-nr-bostwick');
        var nrSolidsEl = document.getElementById('pw-nr-solids');
        
        p.specs.fillWeightMin = fwMinEl ? fwMinEl.value : '';
        p.specs.fillWeightMax = fwMaxEl ? fwMaxEl.value : '';
        p.specs.phMin = phMinEl ? phMinEl.value : '';
        p.specs.phMax = phMaxEl ? phMaxEl.value : '';
        p.specs.brixMin = brixMinEl ? brixMinEl.value : '';
        p.specs.brixMax = brixMaxEl ? brixMaxEl.value : '';
        p.specs.saltMin = saltMinEl ? saltMinEl.value : '';
        p.specs.saltMax = saltMaxEl ? saltMaxEl.value : '';
        p.specs.bostwickMin = bostwickMinEl ? bostwickMinEl.value : '';
        p.specs.bostwickMax = bostwickMaxEl ? bostwickMaxEl.value : '';
        p.specs.solidsMin = solidsMinEl ? solidsMinEl.value : '';
        p.specs.solidsMax = solidsMaxEl ? solidsMaxEl.value : '';
        
        // Store N/R states
        p.specs.notRequired.brix = nrBrixEl ? nrBrixEl.checked : false;
        p.specs.notRequired.salt = nrSaltEl ? nrSaltEl.checked : false;
        p.specs.notRequired.bostwick = nrBostwickEl ? nrBostwickEl.checked : false;
        p.specs.notRequired.solids = nrSolidsEl ? nrSolidsEl.checked : false;
      } else if (step === 3) {
        p.samples = p.samples || {};
        var prEl = document.getElementById('pw-sample-pr');
        var libEl = document.getElementById('pw-sample-lib');
        var incEl = document.getElementById('pw-sample-inc');
        var custEl = document.getElementById('pw-sample-cust');
        
        p.samples.postRetort = prEl ? parseInt(prEl.value) || 0 : 0;
        p.samples.lib = libEl ? parseInt(libEl.value) || 0 : 0;
        p.samples.incubation = incEl ? parseInt(incEl.value) || 0 : 0;
        p.samples.customer = custEl ? parseInt(custEl.value) || 0 : 0;
        
        var certs = [];
        var gfEl = document.getElementById('pw-cert-gf');
        var orgEl = document.getElementById('pw-cert-org');
        var kosherEl = document.getElementById('pw-cert-kosher');
        
        if (gfEl && gfEl.checked) certs.push('Gluten Free');
        if (orgEl && orgEl.checked) certs.push('Organic');
        if (kosherEl && kosherEl.checked) certs.push('Kosher');
        p.certifications = certs;
      }
    }

    function handleLogin() {
      var email = document.getElementById('login-email').value;
      var password = document.getElementById('login-password').value;
      var errorEl = document.getElementById('login-error');
      
      var user = USERS.find(function(u) { return u.email === email && u.password === password; });
      if (user) {
        state.currentUser = user;
        state.view = 'dashboard';
        render();
      } else {
        errorEl.textContent = 'Invalid credentials';
        errorEl.classList.remove('hidden');
      }
    }

    // ============================================================================
    // INIT
    // ============================================================================
    
    render();
  </script>
</body>
</html>
